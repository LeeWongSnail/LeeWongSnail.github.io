<!DOCTYPE html>
<html lang="zh-CN">
    <head>
    <meta charset="utf-8">

    

    <!-- 渲染优化 -->
    <meta name="renderer" content="webkit">
    <meta name="force-rendering" content="webkit">
    <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1">
    <meta name="HandheldFriendly" content="True" >
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

    <!--icon-->

    
        <link rel="shortcut icon" href="https://tva1.sinaimg.cn/large/0081Kckwly1glcsnw2jatj303k03k748.jpg">
    
    
    
    
    


    <!-- meta -->


<title>Runtime之KVC实现探究 | LeeWong</title>


    <meta name="keywords" content="Runtime KVC, iOS">




    <!-- OpenGraph -->
 
    <meta name="description" content="我们都知道iOS开发中有很多黑魔法，KVC就是其中之一，在平时开发中我们也会使用KVC去获取一些系统未公开的API方法，但同时我们可能要承担一些被拒或者因系统API改变导致的问题。这篇文章我们从源码的角度分析KVC的实现。">
<meta property="og:type" content="article">
<meta property="og:title" content="Runtime之KVC实现探究">
<meta property="og:url" content="https://www.leewong.cn/2020/12/19/runtime-KVC/index.html">
<meta property="og:site_name" content="LeeWong">
<meta property="og:description" content="我们都知道iOS开发中有很多黑魔法，KVC就是其中之一，在平时开发中我们也会使用KVC去获取一些系统未公开的API方法，但同时我们可能要承担一些被拒或者因系统API改变导致的问题。这篇文章我们从源码的角度分析KVC的实现。">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://tva1.sinaimg.cn/large/0081Kckwgy1gltj8h40qoj30dw05kq36.jpg">
<meta property="article:published_time" content="2020-12-19T04:39:00.000Z">
<meta property="article:modified_time" content="2020-12-27T05:22:35.628Z">
<meta property="article:author" content="LeeWong">
<meta property="article:tag" content="Runtime KVC">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://tva1.sinaimg.cn/large/0081Kckwgy1gltj8h40qoj30dw05kq36.jpg">


    
<link rel="stylesheet" href="/css/style/main.css">
 


    
<link rel="stylesheet" href="/css/style/dark.css">

    
<script src="/js/darkmode.js"></script>



    
    
    
        <link rel="stylesheet" id="hl-default-theme" href="https://cdn.jsdelivr.net/npm/highlight.js@10.1.2/styles/default.min.css" media="none" onload="if(getComputedStyle(document.documentElement).getPropertyValue('--color-mode').indexOf('dark')===-1)this.media='all'">
        
            <link rel="stylesheet" id="hl-dark-theme" href="https://cdn.jsdelivr.net/npm/highlight.js@10.1.2/styles/dark.min.css" media="none" onload="if(getComputedStyle(document.documentElement).getPropertyValue('--color-mode').indexOf('dark')!==-1)this.media='all'">
        
    

    

     
    <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
 

    <!-- custom head -->

    
        <meta name="google-site-verification" content="4NmLVard-jFEKaV6857m9tKb41Tpo4FiKj8L1TJg7lU" /> 
    

<meta name="generator" content="Hexo 5.1.1"></head>

    <body>
        <div id="app">
            <header class="header">
    <div class="header__left">
        <a href="/" class="button">
            <span class="logo__text">LeeWong</span>
        </a>
    </div>
    <div class="header__right">
        
            <div class="navbar__menus">
                
                    <a href="/" class="navbar-menu button">首页</a>
                
                    <a href="/tags/" class="navbar-menu button">标签</a>
                
                    <a href="/archives/" class="navbar-menu button">归档</a>
                
                    <a href="/about/" class="navbar-menu button">关于我</a>
                
            </div>
        
        
        

        
        
    <a href="javaScript:void(0);" id="btn-toggle-dark">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg>
    </a>


         
    <a href="#" class="button" id="b2t" aria-label="回到顶部" title="回到顶部">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1024 1024" width="32" height="32">
            <path d="M233.376 722.752L278.624 768 512 534.624 745.376 768l45.248-45.248L512 444.128zM192 352h640V288H192z" fill="currentColor"></path>
        </svg>
    </a>


        
            <a class="dropdown-icon button" id="btn-dropdown" tabindex="0"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" width='24' height='24' fill="none" stroke="currentColor" stroke-width="0.7" stroke-linecap="round" stroke-linejoin="round"><path fill="currentColor" d="M3.314,4.8h13.372c0.41,0,0.743-0.333,0.743-0.743c0-0.41-0.333-0.743-0.743-0.743H3.314c-0.41,0-0.743,0.333-0.743,0.743C2.571,4.467,2.904,4.8,3.314,4.8z M16.686,15.2H3.314c-0.41,0-0.743,0.333-0.743,0.743s0.333,0.743,0.743,0.743h13.372c0.41,0,0.743-0.333,0.743-0.743S17.096,15.2,16.686,15.2z M16.686,9.257H3.314c-0.41,0-0.743,0.333-0.743,0.743s0.333,0.743,0.743,0.743h13.372c0.41,0,0.743-0.333,0.743-0.743S17.096,9.257,16.686,9.257z"></path></svg></a>
            <div class="dropdown-menus" id="dropdown-menus">
                
                    <a href="/" class="dropdown-menu button">首页</a>
                
                    <a href="/tags/" class="dropdown-menu button">标签</a>
                
                    <a href="/archives/" class="dropdown-menu button">归档</a>
                
                    <a href="/about/" class="dropdown-menu button">关于我</a>
                
            </div>
        
    </div>
</header>


            <main class="main">
    

<div class="post-title">
    <h1 class="post-title__text">
        Runtime之KVC实现探究
    </h1>
    <div class="post-title__meta">
        <a href="/archives/2020/12/" class="post-meta__date button">2020-12-19</a>
        
    <span class="separate-dot"></span><a href="/categories/Runtime/" class="button">Runtime</a>

 
        
    
     
    <span id="busuanzi_container_page_pv" hidden>
        <span class="separate-dot"></span>
        <span></span>
        <span id="busuanzi_value_page_pv"></span>
        <span>Views</span>
    </span>



 

 
    </div>
</div>


    <aside class="post-side">
        <div class="post-side__toc">
            <ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#KVC%E4%BD%BF%E7%94%A8%E7%A4%BA%E4%BE%8B"><span class="toc-number">1.</span> <span class="toc-text">KVC使用示例</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#KVC%E5%8E%9F%E7%90%86"><span class="toc-number">2.</span> <span class="toc-text">KVC原理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#KVC%E5%AE%9E%E7%8E%B0%E7%8C%9C%E6%83%B3"><span class="toc-number">3.</span> <span class="toc-text">KVC实现猜想</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#KVC%E7%9A%84%E5%AE%9E%E7%8E%B0"><span class="toc-number">4.</span> <span class="toc-text">KVC的实现</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#setValue-forKey"><span class="toc-number">4.1.</span> <span class="toc-text">setValue: forKey</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%B1%9E%E6%80%A7%E8%AE%BE%E7%BD%AE%E4%B8%BAnil"><span class="toc-number">4.1.1.</span> <span class="toc-text">属性设置为nil</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%9F%A5%E6%89%BE%E5%AF%B9%E5%BA%94%E7%9A%84%E6%88%90%E5%91%98%E5%8F%98%E9%87%8F"><span class="toc-number">4.1.2.</span> <span class="toc-text">查找对应的成员变量</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%9C%AA%E6%89%BE%E5%88%B0%E5%AF%B9%E5%BA%94%E7%9A%84%E5%B1%9E%E6%80%A7"><span class="toc-number">4.1.3.</span> <span class="toc-text">未找到对应的属性</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#valueForKey"><span class="toc-number">4.2.</span> <span class="toc-text">valueForKey:</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%9F%A5%E6%89%BEkey%E5%AF%B9%E5%BA%94%E7%9A%84%E6%96%B9%E6%B3%95"><span class="toc-number">4.2.1.</span> <span class="toc-text">查找key对应的方法</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%90%9C%E7%B4%A2%E9%9B%86%E5%90%88%E7%B1%BB%E5%9E%8B%E7%9B%B8%E5%85%B3%E6%96%B9%E6%B3%95"><span class="toc-number">4.2.2.</span> <span class="toc-text">搜索集合类型相关方法</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#NSArray-%E6%90%9C%E7%B4%A2%E6%95%B0%E7%BB%84%E7%9B%B8%E5%85%B3%E6%96%B9%E6%B3%95"><span class="toc-number">4.2.3.</span> <span class="toc-text">NSArray 搜索数组相关方法</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#NSSet-%E7%9B%B8%E5%85%B3%E6%90%9C%E7%B4%A2%E6%96%B9%E6%B3%95"><span class="toc-number">4.2.4.</span> <span class="toc-text">NSSet 相关搜索方法</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%90%9C%E7%B4%A2%E5%AE%9E%E4%BE%8B%E5%8F%98%E9%87%8F"><span class="toc-number">4.2.5.</span> <span class="toc-text">搜索实例变量</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#valueForUndefinedKey"><span class="toc-number">4.2.6.</span> <span class="toc-text">valueForUndefinedKey</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%9B%86%E5%90%88%E7%B1%BB%E5%9E%8B"><span class="toc-number">5.</span> <span class="toc-text">集合类型</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#mutableArrayValueForKey"><span class="toc-number">5.1.</span> <span class="toc-text">mutableArrayValueForKey</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%96%91%E9%97%AE%EF%BC%9F"><span class="toc-number">5.2.</span> <span class="toc-text">疑问？</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#mutableArrayValueForKey-amp-KVO"><span class="toc-number">5.3.</span> <span class="toc-text">mutableArrayValueForKey&amp;KVO</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#KVC-%E5%BA%94%E7%94%A8"><span class="toc-number">6.</span> <span class="toc-text">KVC 应用</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%B8%B8%E8%A7%84%E6%93%8D%E4%BD%9C%E7%AC%A6"><span class="toc-number">6.1.</span> <span class="toc-text">常规操作符</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%9B%86%E5%90%88%E5%8E%BB%E9%87%8D"><span class="toc-number">6.2.</span> <span class="toc-text">集合去重</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%80%BB%E7%BB%93"><span class="toc-number">7.</span> <span class="toc-text">总结</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8F%82%E8%80%83"><span class="toc-number">8.</span> <span class="toc-text">参考</span></a></li></ol>
        </div>
    </aside>
    <a class="btn-toc button" id="btn-toc" tabindex="0">
        <svg viewBox="0 0 1024 1024" width="32" height="32" xmlns="http://www.w3.org/2000/svg">
            <path d="M128 256h64V192H128zM320 256h576V192H320zM128 544h64v-64H128zM320 544h576v-64H320zM128 832h64v-64H128zM320 832h576v-64H320z" fill="currentColor"></path>
        </svg>
    </a>
    <div class="toc-menus" id="toc-menus">
        <div class="toc-title">文章目录</div>
        <ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#KVC%E4%BD%BF%E7%94%A8%E7%A4%BA%E4%BE%8B"><span class="toc-number">1.</span> <span class="toc-text">KVC使用示例</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#KVC%E5%8E%9F%E7%90%86"><span class="toc-number">2.</span> <span class="toc-text">KVC原理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#KVC%E5%AE%9E%E7%8E%B0%E7%8C%9C%E6%83%B3"><span class="toc-number">3.</span> <span class="toc-text">KVC实现猜想</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#KVC%E7%9A%84%E5%AE%9E%E7%8E%B0"><span class="toc-number">4.</span> <span class="toc-text">KVC的实现</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#setValue-forKey"><span class="toc-number">4.1.</span> <span class="toc-text">setValue: forKey</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%B1%9E%E6%80%A7%E8%AE%BE%E7%BD%AE%E4%B8%BAnil"><span class="toc-number">4.1.1.</span> <span class="toc-text">属性设置为nil</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%9F%A5%E6%89%BE%E5%AF%B9%E5%BA%94%E7%9A%84%E6%88%90%E5%91%98%E5%8F%98%E9%87%8F"><span class="toc-number">4.1.2.</span> <span class="toc-text">查找对应的成员变量</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%9C%AA%E6%89%BE%E5%88%B0%E5%AF%B9%E5%BA%94%E7%9A%84%E5%B1%9E%E6%80%A7"><span class="toc-number">4.1.3.</span> <span class="toc-text">未找到对应的属性</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#valueForKey"><span class="toc-number">4.2.</span> <span class="toc-text">valueForKey:</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%9F%A5%E6%89%BEkey%E5%AF%B9%E5%BA%94%E7%9A%84%E6%96%B9%E6%B3%95"><span class="toc-number">4.2.1.</span> <span class="toc-text">查找key对应的方法</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%90%9C%E7%B4%A2%E9%9B%86%E5%90%88%E7%B1%BB%E5%9E%8B%E7%9B%B8%E5%85%B3%E6%96%B9%E6%B3%95"><span class="toc-number">4.2.2.</span> <span class="toc-text">搜索集合类型相关方法</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#NSArray-%E6%90%9C%E7%B4%A2%E6%95%B0%E7%BB%84%E7%9B%B8%E5%85%B3%E6%96%B9%E6%B3%95"><span class="toc-number">4.2.3.</span> <span class="toc-text">NSArray 搜索数组相关方法</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#NSSet-%E7%9B%B8%E5%85%B3%E6%90%9C%E7%B4%A2%E6%96%B9%E6%B3%95"><span class="toc-number">4.2.4.</span> <span class="toc-text">NSSet 相关搜索方法</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%90%9C%E7%B4%A2%E5%AE%9E%E4%BE%8B%E5%8F%98%E9%87%8F"><span class="toc-number">4.2.5.</span> <span class="toc-text">搜索实例变量</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#valueForUndefinedKey"><span class="toc-number">4.2.6.</span> <span class="toc-text">valueForUndefinedKey</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%9B%86%E5%90%88%E7%B1%BB%E5%9E%8B"><span class="toc-number">5.</span> <span class="toc-text">集合类型</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#mutableArrayValueForKey"><span class="toc-number">5.1.</span> <span class="toc-text">mutableArrayValueForKey</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%96%91%E9%97%AE%EF%BC%9F"><span class="toc-number">5.2.</span> <span class="toc-text">疑问？</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#mutableArrayValueForKey-amp-KVO"><span class="toc-number">5.3.</span> <span class="toc-text">mutableArrayValueForKey&amp;KVO</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#KVC-%E5%BA%94%E7%94%A8"><span class="toc-number">6.</span> <span class="toc-text">KVC 应用</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%B8%B8%E8%A7%84%E6%93%8D%E4%BD%9C%E7%AC%A6"><span class="toc-number">6.1.</span> <span class="toc-text">常规操作符</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%9B%86%E5%90%88%E5%8E%BB%E9%87%8D"><span class="toc-number">6.2.</span> <span class="toc-text">集合去重</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%80%BB%E7%BB%93"><span class="toc-number">7.</span> <span class="toc-text">总结</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8F%82%E8%80%83"><span class="toc-number">8.</span> <span class="toc-text">参考</span></a></li></ol>
    </div>


<article class="post content-card">
    <div class="post__header">
    
        <div class="post-thumbnail" style="background-image: url('https://tva1.sinaimg.cn/large/0081Kckwgy1gltj8h40qoj30dw05kq36.jpg');"></div>
    
</div>
    <div class="post__content">
        <p>我们都知道iOS开发中有很多<code>黑魔法</code>，KVC就是其中之一，在平时开发中我们也会使用KVC去获取一些系统未公开的API方法，但同时我们可能要承担一些被拒或者因系统API改变导致的问题。这篇文章我们从源码的角度分析KVC的实现。</p>
<a id="more"></a>

<h3 id="KVC使用示例"><a href="#KVC使用示例" class="headerlink" title="KVC使用示例"></a>KVC使用示例</h3><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs objc">- (<span class="hljs-keyword">void</span>)kvcValueForKeyTest &#123;<br>    <span class="hljs-keyword">self</span>.p = [Person new];<br><br>    <span class="hljs-keyword">self</span>.p.name = <span class="hljs-string">@&quot;LeeWong&quot;</span>;<br>    <span class="hljs-keyword">self</span>.p.age = <span class="hljs-number">30</span>;<br><br>    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;Person age = %@&quot;</span>,<span class="hljs-keyword">self</span>.p.name);<br>    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;Person name = %@&quot;</span>,@(<span class="hljs-keyword">self</span>.p.age));<br>&#125;<br><br>- (<span class="hljs-keyword">void</span>)kvcSetValueForKey &#123;<br>    <span class="hljs-keyword">self</span>.p = [Person new];<br><br>    [<span class="hljs-keyword">self</span>.p setValue:<span class="hljs-string">@&quot;LeeWong&quot;</span> forKey:<span class="hljs-string">@&quot;name&quot;</span>];<br>    [<span class="hljs-keyword">self</span>.p setValue:@(<span class="hljs-number">30</span>) forKey:<span class="hljs-string">@&quot;age&quot;</span>];<br><br>    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;Person age = %@&quot;</span>,[<span class="hljs-keyword">self</span>.p valueForKey:<span class="hljs-string">@&quot;age&quot;</span>]);<br>    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;Person name = %@&quot;</span>,[<span class="hljs-keyword">self</span>.p valueForKey:<span class="hljs-string">@&quot;name&quot;</span>]);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>打印结果:</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs objc"><span class="hljs-number">2020</span><span class="hljs-number">-12</span><span class="hljs-number">-19</span> <span class="hljs-number">18</span>:<span class="hljs-number">52</span>:<span class="hljs-number">54.058580</span>+<span class="hljs-number">0800</span> Runtime-KVC[<span class="hljs-number">99046</span>:<span class="hljs-number">16759483</span>] Person age = <span class="hljs-number">30</span><br><span class="hljs-number">2020</span><span class="hljs-number">-12</span><span class="hljs-number">-19</span> <span class="hljs-number">18</span>:<span class="hljs-number">52</span>:<span class="hljs-number">54.058700</span>+<span class="hljs-number">0800</span> Runtime-KVC[<span class="hljs-number">99046</span>:<span class="hljs-number">16759483</span>] Person name = LeeWong<br><span class="hljs-number">2020</span><span class="hljs-number">-12</span><span class="hljs-number">-19</span> <span class="hljs-number">18</span>:<span class="hljs-number">52</span>:<span class="hljs-number">54.058784</span>+<span class="hljs-number">0800</span> Runtime-KVC[<span class="hljs-number">99046</span>:<span class="hljs-number">16759483</span>] -----------------------------<br><span class="hljs-number">2020</span><span class="hljs-number">-12</span><span class="hljs-number">-19</span> <span class="hljs-number">18</span>:<span class="hljs-number">52</span>:<span class="hljs-number">54.058882</span>+<span class="hljs-number">0800</span> Runtime-KVC[<span class="hljs-number">99046</span>:<span class="hljs-number">16759483</span>] Person age = LeeWong<br><span class="hljs-number">2020</span><span class="hljs-number">-12</span><span class="hljs-number">-19</span> <span class="hljs-number">18</span>:<span class="hljs-number">52</span>:<span class="hljs-number">54.058990</span>+<span class="hljs-number">0800</span> Runtime-KVC[<span class="hljs-number">99046</span>:<span class="hljs-number">16759483</span>] Person name = <span class="hljs-number">30</span><br></code></pre></td></tr></table></figure>

<p>这两种情况是我们平时应用最广泛的KVC(Key-Value-Coding)的方法，通常用来获取属性值或者给对象的某个属性值赋值,即使对象的属性是私有的只要我们可以确认他的key值，我们就可以获取或者设置值。</p>
<h3 id="KVC原理"><a href="#KVC原理" class="headerlink" title="KVC原理"></a>KVC原理</h3><p>在查看KVC相关方法时，我们发现其主要的方法都集中在<code>NSKeyValueCoding.h</code>这个文件中,下面我们来看下这个文件中的方法：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><code class="hljs objc"><span class="hljs-keyword">@property</span> (<span class="hljs-keyword">class</span>, <span class="hljs-keyword">readonly</span>) <span class="hljs-built_in">BOOL</span> accessInstanceVariablesDirectly;<br>- (<span class="hljs-keyword">void</span>)setValue:(<span class="hljs-keyword">nullable</span> <span class="hljs-keyword">id</span>)value forKey:(<span class="hljs-built_in">NSString</span> *)key;<br>- (<span class="hljs-built_in">BOOL</span>)validateValue:(<span class="hljs-keyword">inout</span> <span class="hljs-keyword">id</span> _Nullable * _Nonnull)ioValue forKey:(<span class="hljs-built_in">NSString</span> *)inKey error:(<span class="hljs-keyword">out</span> <span class="hljs-built_in">NSError</span> **)outError;<br>- (<span class="hljs-built_in">NSMutableArray</span> *)mutableArrayValueForKey:(<span class="hljs-built_in">NSString</span> *)key;<br>- (<span class="hljs-built_in">NSMutableOrderedSet</span> *)mutableOrderedSetValueForKey:(<span class="hljs-built_in">NSString</span> *)key API_AVAILABLE(macos(<span class="hljs-number">10.7</span>), ios(<span class="hljs-number">5.0</span>), watchos(<span class="hljs-number">2.0</span>), tvos(<span class="hljs-number">9.0</span>));<br>- (<span class="hljs-built_in">NSMutableSet</span> *)mutableSetValueForKey:(<span class="hljs-built_in">NSString</span> *)key;<br>- (<span class="hljs-keyword">nullable</span> <span class="hljs-keyword">id</span>)valueForKeyPath:(<span class="hljs-built_in">NSString</span> *)keyPath;<br>- (<span class="hljs-keyword">void</span>)setValue:(<span class="hljs-keyword">nullable</span> <span class="hljs-keyword">id</span>)value forKeyPath:(<span class="hljs-built_in">NSString</span> *)keyPath;<br>- (<span class="hljs-built_in">BOOL</span>)validateValue:(<span class="hljs-keyword">inout</span> <span class="hljs-keyword">id</span> _Nullable * _Nonnull)ioValue forKeyPath:(<span class="hljs-built_in">NSString</span> *)inKeyPath error:(<span class="hljs-keyword">out</span> <span class="hljs-built_in">NSError</span> **)outError;<br>- (<span class="hljs-built_in">NSMutableArray</span> *)mutableArrayValueForKeyPath:(<span class="hljs-built_in">NSString</span> *)keyPath;<br>- (<span class="hljs-built_in">NSMutableOrderedSet</span> *)mutableOrderedSetValueForKeyPath:(<span class="hljs-built_in">NSString</span> *)keyPath API_AVAILABLE(macos(<span class="hljs-number">10.7</span>), ios(<span class="hljs-number">5.0</span>), watchos(<span class="hljs-number">2.0</span>), tvos(<span class="hljs-number">9.0</span>));<br>- (<span class="hljs-built_in">NSMutableSet</span> *)mutableSetValueForKeyPath:(<span class="hljs-built_in">NSString</span> *)keyPath;<br>- (<span class="hljs-keyword">nullable</span> <span class="hljs-keyword">id</span>)valueForUndefinedKey:(<span class="hljs-built_in">NSString</span> *)key;<br>- (<span class="hljs-keyword">void</span>)setValue:(<span class="hljs-keyword">nullable</span> <span class="hljs-keyword">id</span>)value forUndefinedKey:(<span class="hljs-built_in">NSString</span> *)key;<br>- (<span class="hljs-keyword">void</span>)setNilValueForKey:(<span class="hljs-built_in">NSString</span> *)key;<br>- (<span class="hljs-built_in">NSDictionary</span>&lt;<span class="hljs-built_in">NSString</span> *, <span class="hljs-keyword">id</span>&gt; *)dictionaryWithValuesForKeys:(<span class="hljs-built_in">NSArray</span>&lt;<span class="hljs-built_in">NSString</span> *&gt; *)keys;<br>- (<span class="hljs-keyword">void</span>)setValuesForKeysWithDictionary:(<span class="hljs-built_in">NSDictionary</span>&lt;<span class="hljs-built_in">NSString</span> *, <span class="hljs-keyword">id</span>&gt; *)keyedValues;<br><br><span class="hljs-keyword">@end</span><br><br><span class="hljs-class"><span class="hljs-keyword">@interface</span> <span class="hljs-title">NSArray</span>&lt;<span class="hljs-title">ObjectType</span>&gt;(<span class="hljs-title">NSKeyValueCoding</span>)</span><br>- (<span class="hljs-keyword">id</span>)valueForKey:(<span class="hljs-built_in">NSString</span> *)key;<br>- (<span class="hljs-keyword">void</span>)setValue:(<span class="hljs-keyword">nullable</span> <span class="hljs-keyword">id</span>)value forKey:(<span class="hljs-built_in">NSString</span> *)key;<br><br><span class="hljs-keyword">@end</span><br><br><span class="hljs-class"><span class="hljs-keyword">@interface</span> <span class="hljs-title">NSDictionary</span>&lt;<span class="hljs-title">KeyType</span>, <span class="hljs-title">ObjectType</span>&gt;(<span class="hljs-title">NSKeyValueCoding</span>)</span><br>- (<span class="hljs-keyword">nullable</span> ObjectType)valueForKey:(<span class="hljs-built_in">NSString</span> *)key;<br><br><span class="hljs-keyword">@end</span><br><br><span class="hljs-class"><span class="hljs-keyword">@interface</span> <span class="hljs-title">NSMutableDictionary</span>&lt;<span class="hljs-title">KeyType</span>, <span class="hljs-title">ObjectType</span>&gt;(<span class="hljs-title">NSKeyValueCoding</span>)</span><br><br>- (<span class="hljs-keyword">void</span>)setValue:(<span class="hljs-keyword">nullable</span> ObjectType)value forKey:(<span class="hljs-built_in">NSString</span> *)key;<br><br><span class="hljs-keyword">@end</span><br><br><span class="hljs-class"><span class="hljs-keyword">@interface</span> <span class="hljs-title">NSOrderedSet</span>&lt;<span class="hljs-title">ObjectType</span>&gt;(<span class="hljs-title">NSKeyValueCoding</span>)</span><br>- (<span class="hljs-keyword">id</span>)valueForKey:(<span class="hljs-built_in">NSString</span> *)key API_AVAILABLE(macos(<span class="hljs-number">10.7</span>), ios(<span class="hljs-number">5.0</span>), watchos(<span class="hljs-number">2.0</span>), tvos(<span class="hljs-number">9.0</span>));<br><br>- (<span class="hljs-keyword">void</span>)setValue:(<span class="hljs-keyword">nullable</span> <span class="hljs-keyword">id</span>)value forKey:(<span class="hljs-built_in">NSString</span> *)key API_AVAILABLE(macos(<span class="hljs-number">10.7</span>), ios(<span class="hljs-number">5.0</span>), watchos(<span class="hljs-number">2.0</span>), tvos(<span class="hljs-number">9.0</span>));<br><br><span class="hljs-keyword">@end</span><br><br><span class="hljs-class"><span class="hljs-keyword">@interface</span> <span class="hljs-title">NSSet</span>&lt;<span class="hljs-title">ObjectType</span>&gt;(<span class="hljs-title">NSKeyValueCoding</span>)</span><br><br>- (<span class="hljs-keyword">id</span>)valueForKey:(<span class="hljs-built_in">NSString</span> *)key;<br><br>- (<span class="hljs-keyword">void</span>)setValue:(<span class="hljs-keyword">nullable</span> <span class="hljs-keyword">id</span>)value forKey:(<span class="hljs-built_in">NSString</span> *)key;<br><br><span class="hljs-keyword">@end</span><br></code></pre></td></tr></table></figure>

<p>这个文件中主要包含了<br><code>NSObject(NSKeyValueCoding)</code>,<br><code>NSArray&lt;ObjectType&gt;(NSKeyValueCoding)</code>,<br><code>NSDictionary&lt;KeyType,ObjectType&gt;(NSKeyValueCoding)</code>,<br><code>NSMutableDictionary&lt;KeyType,ObjectType&gt;(NSKeyValueCoding)</code>,<br><code>NSOrderedSet&lt;ObjectType&gt;(NSKeyValueCoding)</code>,<br><code>NSSet&lt;ObjectType&gt;(NSKeyValueCoding)</code><br>主要是常用的NSObject以及集合类型<code>NSArray</code>,<code>NSDictionary</code>,<code>NSMutableDictionary</code>,<code>NSOrderedSet</code>,<code>NSSet</code>的KVC相关方法分类。从这个分类中的分组我们也将本篇文章要讲述的内容分为两部分NSOject和集合类型的属性。</p>
<h3 id="KVC实现猜想"><a href="#KVC实现猜想" class="headerlink" title="KVC实现猜想"></a>KVC实现猜想</h3><p>我们在前面一篇文章中提到了KVO的实现,系统实际上继承我们要监听的类创建了一个子类，然后在子类中重写对应属性的<code>setter</code>方法，然后在设置值方法的前后调用了<code>willChangeValueForKey</code>和<code>didChangeValueForKey</code>的方法通知外部的监听者。</p>
<p>那么我们首先看下KVC获取到的对象的类型有没有改变：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs objc">- (<span class="hljs-keyword">void</span>)kvoObjectClassChangeTest &#123;<br>    <span class="hljs-keyword">self</span>.father = [Father new];<br><br>    Son *son1 = [Son new];<br>    Son *son2 = [Son new];<br>    <span class="hljs-keyword">self</span>.father.name = <span class="hljs-string">@&quot;LeeWong&quot;</span>;<br>    <span class="hljs-keyword">self</span>.father.children = @[son1,son2];<br><br>    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;Father 的children 类型是%@&quot;</span>,[[<span class="hljs-keyword">self</span>.father valueForKey:<span class="hljs-string">@&quot;children&quot;</span>] <span class="hljs-keyword">class</span>]);<br>    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;Father 的children 类型是%@&quot;</span>,object_getClass([<span class="hljs-keyword">self</span>.father valueForKey:<span class="hljs-string">@&quot;children&quot;</span>]));<br><br>    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;Father 的name 类型是 %@&quot;</span>,[[<span class="hljs-keyword">self</span>.father valueForKey:<span class="hljs-string">@&quot;name&quot;</span>] <span class="hljs-keyword">class</span>]);<br>    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;Father 的name 类型是 %@&quot;</span>,object_getClass([<span class="hljs-keyword">self</span>.father valueForKey:<span class="hljs-string">@&quot;name&quot;</span>]));<br><br>&#125;<br></code></pre></td></tr></table></figure>
<p>打印结果：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs objc"><span class="hljs-number">2020</span><span class="hljs-number">-12</span><span class="hljs-number">-19</span> <span class="hljs-number">20</span>:<span class="hljs-number">40</span>:<span class="hljs-number">29.671973</span>+<span class="hljs-number">0800</span> Runtime-KVC[<span class="hljs-number">1432</span>:<span class="hljs-number">16837560</span>] Father 的children 类型是__NSArrayI<br><span class="hljs-number">2020</span><span class="hljs-number">-12</span><span class="hljs-number">-19</span> <span class="hljs-number">20</span>:<span class="hljs-number">40</span>:<span class="hljs-number">29.672078</span>+<span class="hljs-number">0800</span> Runtime-KVC[<span class="hljs-number">1432</span>:<span class="hljs-number">16837560</span>] Father 的children 类型是__NSArrayI<br><span class="hljs-number">2020</span><span class="hljs-number">-12</span><span class="hljs-number">-19</span> <span class="hljs-number">20</span>:<span class="hljs-number">40</span>:<span class="hljs-number">29.672189</span>+<span class="hljs-number">0800</span> Runtime-KVC[<span class="hljs-number">1432</span>:<span class="hljs-number">16837560</span>] Father 的name 类型是 __NSCFConstantString<br><span class="hljs-number">2020</span><span class="hljs-number">-12</span><span class="hljs-number">-19</span> <span class="hljs-number">20</span>:<span class="hljs-number">40</span>:<span class="hljs-number">29.672306</span>+<span class="hljs-number">0800</span> Runtime-KVC[<span class="hljs-number">1432</span>:<span class="hljs-number">16837560</span>] Father 的name 类型是 __NSCFConstantString<br></code></pre></td></tr></table></figure>

<p>这里我们看出KVC并没有给我们要获取的属性或者类动态添加子类或者其他属性，那么到底是怎么实现的呢？</p>
<p>否定了刚才的想法后，我们知道Runtime是可以动态获取到对象的所有属性的，那是否意味着当我们去给对象的属性通过setValue:forKey方法设值的时候是动态的获取这个对象的属性列表，如果属性列表中包含要设置的key那么久调用这个key对应的设置方法实现的呢？</p>
<p>下面我们通过这段代码验证下：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs objc"><br><span class="hljs-keyword">@synthesize</span> name = _name;<br><br><br>- (<span class="hljs-keyword">void</span>)setName:(<span class="hljs-built_in">NSString</span> *)name &#123;<br>    _name = name;<br>    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;Person setName %@&quot;</span>,name);<br>&#125;<br><br>- (<span class="hljs-built_in">NSString</span> *)name &#123;<br>    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;Person getname %@&quot;</span>,_name);<br>    <span class="hljs-keyword">return</span> _name;<br>&#125;<br><br>- (<span class="hljs-keyword">void</span>)kvoSetMethodCallTest &#123;<br>    <span class="hljs-keyword">self</span>.father = [Father new];<br>    [<span class="hljs-keyword">self</span>.father setValue:<span class="hljs-string">@&quot;LeeWong&quot;</span> forKey:<span class="hljs-string">@&quot;name&quot;</span>];<br><br>    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;kvoSetMethodCallTest father name %@&quot;</span>,<span class="hljs-keyword">self</span>.father.name);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>我们调用<code>kvoSetMethodCallTest</code>方法后控制台输出结果如下：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs objc"><span class="hljs-number">2020</span><span class="hljs-number">-12</span><span class="hljs-number">-19</span> <span class="hljs-number">20</span>:<span class="hljs-number">53</span>:<span class="hljs-number">05.265737</span>+<span class="hljs-number">0800</span> Runtime-KVC[<span class="hljs-number">1701</span>:<span class="hljs-number">16847901</span>] Person setName LeeWong<br><span class="hljs-number">2020</span><span class="hljs-number">-12</span><span class="hljs-number">-19</span> <span class="hljs-number">20</span>:<span class="hljs-number">53</span>:<span class="hljs-number">05.265856</span>+<span class="hljs-number">0800</span> Runtime-KVC[<span class="hljs-number">1701</span>:<span class="hljs-number">16847901</span>] Person getname LeeWong<br><span class="hljs-number">2020</span><span class="hljs-number">-12</span><span class="hljs-number">-19</span> <span class="hljs-number">20</span>:<span class="hljs-number">53</span>:<span class="hljs-number">05.265937</span>+<span class="hljs-number">0800</span> Runtime-KVC[<span class="hljs-number">1701</span>:<span class="hljs-number">16847901</span>] kvoSetMethodCallTest father name LeeWong<br></code></pre></td></tr></table></figure>

<p>通过上述输出我们看到实际上无论是<code>setValue:forKey</code>还是<code>valueForKey:</code>最终都是调用到了属性的setter和getter方法。</p>
<p>那么我们的猜想基本得到验证了，那么我们下面就来看下是如何调用到getter和setter方法的呢？</p>
<h3 id="KVC的实现"><a href="#KVC的实现" class="headerlink" title="KVC的实现"></a>KVC的实现</h3><p>在了解KVC实现之前我们首先需要了解下KVC相关方法：</p>
<h4 id="setValue-forKey"><a href="#setValue-forKey" class="headerlink" title="setValue: forKey"></a>setValue: forKey</h4><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs objc"><br><span class="hljs-comment">/* Given a value and a key that identifies an attribute, set the value of the attribute. Given an object and a key that identifies a to-one relationship, relate the object to the receiver, unrelating the previously related object if there was one. Given a collection object and a key that identifies a to-many relationship, relate the objects contained in the collection to the receiver, unrelating previously related objects if there were any.</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">The default implementation of this method does the following:</span><br><span class="hljs-comment">    1. Searches the class of the receiver for an accessor method whose name</span><br><span class="hljs-comment"> matches the pattern -set&lt;Key&gt;:. If such a method is found the type of its </span><br><span class="hljs-comment"> parameter is checked. If the parameter type is not an object pointer type but the</span><br><span class="hljs-comment">  value is nil -setNilValueForKey: is invoked. The default implementation of </span><br><span class="hljs-comment">  -setNilValueForKey: raises an NSInvalidArgumentException, but you can override </span><br><span class="hljs-comment">  it in your application. Otherwise, if the type of the method&#x27;s parameter is an </span><br><span class="hljs-comment">  object pointer type the method is simply invoked with the value as the argument.</span><br><span class="hljs-comment">   If the type of the method&#x27;s parameter is some other type the inverse of the </span><br><span class="hljs-comment">   NSNumber/NSValue conversion done by -valueForKey: is performed before the </span><br><span class="hljs-comment">   method is invoked.</span><br><span class="hljs-comment">   </span><br><span class="hljs-comment">    2. Otherwise (no accessor method is found), if the receiver&#x27;s class&#x27; +accessInstanceVariablesDirectly property returns YES, searches the class of the</span><br><span class="hljs-comment"> receiver for an instance variable whose name matches the pattern _&lt;key&gt;, </span><br><span class="hljs-comment"> _is&lt;Key&gt;, &lt;key&gt;, or is&lt;Key&gt;, in that order. If such an instance variable is found </span><br><span class="hljs-comment"> and its type is an object pointer type the value is retained and the result is </span><br><span class="hljs-comment"> set in the instance variable, after the instance variable&#x27;s old value is first </span><br><span class="hljs-comment"> released. If the instance variable&#x27;s type is some other type its value is set </span><br><span class="hljs-comment"> after the same sort of conversion from NSNumber or NSValue as in step 1.</span><br><span class="hljs-comment"> </span><br><span class="hljs-comment">    3. Otherwise (no accessor method or instance variable is found), invokes -setValue:forUndefinedKey:. The default implementation of</span><br><span class="hljs-comment">-setValue:forUndefinedKey: raises an NSUndefinedKeyException, but you can override </span><br><span class="hljs-comment">it in your application.</span><br><span class="hljs-comment"></span><br><span class="hljs-comment"></span><br><span class="hljs-comment">Compatibility notes:</span><br><span class="hljs-comment">    - For backward binary compatibility with -takeValue:forKey:&#x27;s behavior, a method whose name matches the pattern -_set&lt;Key&gt;: is also recognized in step 1. KVC accessor methods whose names start with underscores were deprecated as of Mac OS 10.3 though.</span><br><span class="hljs-comment">    - For backward binary compatibility, -unableToSetNilForKey: will be invoked instead of -setNilValueForKey: in step 1, if the implementation of -unableToSetNilForKey: in the receiver&#x27;s class is not NSObject&#x27;s.</span><br><span class="hljs-comment">    - The behavior described in step 2 is different from -takeValue:forKey:&#x27;s, in which the instance variable search order is &lt;key&gt;, _&lt;key&gt;.</span><br><span class="hljs-comment">    - For backward binary compatibility with -takeValue:forKey:&#x27;s behavior, -handleTakeValue:forUnboundKey: will be invoked instead of -setValue:forUndefinedKey: in step 3, if the implementation of -handleTakeValue:forUnboundKey: in the receiver&#x27;s class is not NSObject&#x27;s.</span><br><span class="hljs-comment">*/</span><br>- (<span class="hljs-keyword">void</span>)setValue:(<span class="hljs-keyword">nullable</span> <span class="hljs-keyword">id</span>)value forKey:(<span class="hljs-built_in">NSString</span> *)key;<br></code></pre></td></tr></table></figure>

<p>实际上上面的方法注释中已经明确告知我们方法的实现了：</p>
<ul>
<li>给定一个值和一个标识属性的键，请设置属性的值；</li>
<li>给定一个对象和一个标识一对一关系的key，将该对象与接收者相关联，如果存在则取消先前相关的对象的关联；</li>
<li>给定一个集合对象和一个标识多对多关系的key，将包含在集合中的对象与接收者相关联，如果存在则取消先前相关的对象的关联；</li>
</ul>
<p>方法的实现步骤如下：</p>
<ul>
<li>搜索该类以及父类中名称符合-set<Key>:格式的方法，如果找到，检查其参数类型。如果参数类型不是对象类型且参数为nil，则调用-setNilValueForKey:方法，这个方法的默认实现是抛出NSInvalidArgumentException异常，不过你可以重写该方法自行实现。如果参数类型为对象类型，set<Key>:方法会被直接调用，这个参数也会被直接使用。如果参数能被转化为NSNumber/NSValue类型，参数会在存取器方法被调用之前进行转换。</li>
<li>如果方法没有被找到，如果对象的+accessInstanceVariablesDirectly属性返回的是YES，那么按照_<key>, _is<Key>, <key>, is<Key>的顺序搜索该类的实例变量。如果找到这个实例变量，当其为对象类型时，该实例变量会在旧值释放之后被设置新值。当其为其他类型时，那么按照步骤1中的类型转换规则设置这个实例变量的值。</li>
<li>如果上述两步都失败了，方法和实例变量都没有被找到，-setValue:forUndefinedKey:方法将会被调用。这个方法的默认实现是抛出NSUndefinedKeyException异常，不过你可以重写该方法自行实现。</li>
</ul>
<p>下面我们来验证下API所说：</p>
<h5 id="属性设置为nil"><a href="#属性设置为nil" class="headerlink" title="属性设置为nil"></a>属性设置为nil</h5><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs objc"><br>Father.m<br><br>- (<span class="hljs-keyword">void</span>)setNilValueForKey:(<span class="hljs-built_in">NSString</span> *)key &#123;<br>    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;Father setNilValueForKey %@&quot;</span>,key);<br>&#125;<br><br>ViewController.m<br><br>- (<span class="hljs-keyword">void</span>)setValueForKeyTest &#123;<br>    <span class="hljs-keyword">self</span>.father = [Father new];<br>    [<span class="hljs-keyword">self</span>.father setValue:<span class="hljs-literal">nil</span> forKey:<span class="hljs-string">@&quot;name&quot;</span>];<br>    [<span class="hljs-keyword">self</span>.father setValue:<span class="hljs-literal">nil</span> forKey:<span class="hljs-string">@&quot;age&quot;</span>];<br>&#125;<br></code></pre></td></tr></table></figure>

<p>控制台输出结果为:</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs objc"><span class="hljs-number">2020</span><span class="hljs-number">-12</span><span class="hljs-number">-19</span> <span class="hljs-number">21</span>:<span class="hljs-number">42</span>:<span class="hljs-number">29.523439</span>+<span class="hljs-number">0800</span> Runtime-KVC[<span class="hljs-number">2388</span>:<span class="hljs-number">16881195</span>] Person setName (null)<br><span class="hljs-number">2020</span><span class="hljs-number">-12</span><span class="hljs-number">-19</span> <span class="hljs-number">21</span>:<span class="hljs-number">42</span>:<span class="hljs-number">29.523581</span>+<span class="hljs-number">0800</span> Runtime-KVC[<span class="hljs-number">2388</span>:<span class="hljs-number">16881195</span>] Father setNilValueForKey age<br></code></pre></td></tr></table></figure>

<p>这验证了第一步中说的查找set<Key>方法，如果找到了name且未对象类型那么直接调用setName:方法，value会被直接使用，如果找到了setAge方法,但参数不是对象类型且值为nil，那么直接调用setNilValueForKey方法(我们实现了这个方法在内部做了输出操作)。</p>
<h5 id="查找对应的成员变量"><a href="#查找对应的成员变量" class="headerlink" title="查找对应的成员变量"></a>查找对应的成员变量</h5><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs objc"><span class="hljs-class"><span class="hljs-keyword">@interface</span> <span class="hljs-title">Person</span> ()</span><br>&#123;<br>    <span class="hljs-built_in">NSString</span> *_isName1;<br>    <span class="hljs-built_in">NSInteger</span> _isAge1;<br><br>&#125;<br><br>+ (<span class="hljs-built_in">BOOL</span>)accessInstanceVariablesDirectly &#123;<br>    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;Father accessInstanceVariablesDirectly&quot;</span>);<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">YES</span>;<br>&#125;<br><br>- (<span class="hljs-built_in">NSString</span> *)getisNameValue &#123;<br>    <span class="hljs-keyword">return</span> _isName1;<br>&#125;<br><br>- (<span class="hljs-built_in">NSInteger</span>)getisAgeValue &#123;<br>    <span class="hljs-keyword">return</span> _isAge1;<br>&#125;<br><br>ViewController.m<br>- (<span class="hljs-keyword">void</span>)setValueForKeyTest &#123;<br>    <span class="hljs-keyword">self</span>.father = [Father new];<br>    [<span class="hljs-keyword">self</span>.father setValue:<span class="hljs-string">@&quot;LeeWong&quot;</span> forKey:<span class="hljs-string">@&quot;name1&quot;</span>];<br>    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;setValueForKeyTest getisNameValue %@&quot;</span>,[<span class="hljs-keyword">self</span>.father getisNameValue]);<br><br>    [<span class="hljs-keyword">self</span>.father setValue:@(<span class="hljs-number">10</span>) forKey:<span class="hljs-string">@&quot;age1&quot;</span>];<br>    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;setValueForKeyTest getisAgeValue %@&quot;</span>,@([<span class="hljs-keyword">self</span>.father getisAgeValue]));<br>&#125;<br></code></pre></td></tr></table></figure>
<p>控制台打印结果为:</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs objc"><span class="hljs-number">2020</span><span class="hljs-number">-12</span><span class="hljs-number">-19</span> <span class="hljs-number">21</span>:<span class="hljs-number">54</span>:<span class="hljs-number">26.320358</span>+<span class="hljs-number">0800</span> Runtime-KVC[<span class="hljs-number">2685</span>:<span class="hljs-number">16893209</span>] Father accessInstanceVariablesDirectly<br><span class="hljs-number">2020</span><span class="hljs-number">-12</span><span class="hljs-number">-19</span> <span class="hljs-number">21</span>:<span class="hljs-number">54</span>:<span class="hljs-number">26.320474</span>+<span class="hljs-number">0800</span> Runtime-KVC[<span class="hljs-number">2685</span>:<span class="hljs-number">16893209</span>] setValueForKeyTest getisNameValue LeeWong<br><span class="hljs-number">2020</span><span class="hljs-number">-12</span><span class="hljs-number">-19</span> <span class="hljs-number">21</span>:<span class="hljs-number">54</span>:<span class="hljs-number">26.320589</span>+<span class="hljs-number">0800</span> Runtime-KVC[<span class="hljs-number">2685</span>:<span class="hljs-number">16893209</span>] Father accessInstanceVariablesDirectly<br><span class="hljs-number">2020</span><span class="hljs-number">-12</span><span class="hljs-number">-19</span> <span class="hljs-number">21</span>:<span class="hljs-number">54</span>:<span class="hljs-number">26.320705</span>+<span class="hljs-number">0800</span> Runtime-KVC[<span class="hljs-number">2685</span>:<span class="hljs-number">16893209</span>] setValueForKeyTest getisAgeValue <span class="hljs-number">10</span><br></code></pre></td></tr></table></figure>

<p>这个结果验证了我们setValue:forKey:的的第二步，搜索当前类中是否存在<code>_&lt;key&gt;, _is&lt;Key&gt;, &lt;key&gt;, or is&lt;Key&gt;</code>(示例中我们是存在_age1/_name1)的实例变量。</p>
<h5 id="未找到对应的属性"><a href="#未找到对应的属性" class="headerlink" title="未找到对应的属性"></a>未找到对应的属性</h5><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs objc">Person.m<br><br>- (<span class="hljs-keyword">void</span>)setValue:(<span class="hljs-keyword">id</span>)value forUndefinedKey:(<span class="hljs-built_in">NSString</span> *)key &#123;<br>    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;Person setValue %@ forUndefinedKey %@&quot;</span>,value,key);<br>&#125;<br><br>ViewController.m<br>- (<span class="hljs-keyword">void</span>)setValueForUndefineKeyTest &#123;<br>    <span class="hljs-keyword">self</span>.father = [Father new];<br>    [<span class="hljs-keyword">self</span>.father setValue:<span class="hljs-string">@&quot;LeeWong&quot;</span> forKey:<span class="hljs-string">@&quot;name1&quot;</span>];<br><br>    [<span class="hljs-keyword">self</span>.father setValue:@(<span class="hljs-number">10</span>) forKey:<span class="hljs-string">@&quot;age1&quot;</span>];<br>&#125;<br></code></pre></td></tr></table></figure>

<p>控制台打印结果:</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs objc"><span class="hljs-number">2020</span><span class="hljs-number">-12</span><span class="hljs-number">-19</span> <span class="hljs-number">22</span>:<span class="hljs-number">01</span>:<span class="hljs-number">02.601408</span>+<span class="hljs-number">0800</span> Runtime-KVC[<span class="hljs-number">2814</span>:<span class="hljs-number">16898946</span>] Person setValue LeeWong forUndefinedKey name1<br><span class="hljs-number">2020</span><span class="hljs-number">-12</span><span class="hljs-number">-19</span> <span class="hljs-number">22</span>:<span class="hljs-number">01</span>:<span class="hljs-number">02.601546</span>+<span class="hljs-number">0800</span> Runtime-KVC[<span class="hljs-number">2814</span>:<span class="hljs-number">16898946</span>] Person setValue <span class="hljs-number">10</span> forUndefinedKey age1<br></code></pre></td></tr></table></figure>

<p>综合上面几步，我们总结了下setValue:forKey:的调用流程为:</p>
<p><img src="https://tva1.sinaimg.cn/large/0081Kckwly1gltj1ctkjjj31ja0okdjx.jpg" alt="调用流程"></p>
<h4 id="valueForKey"><a href="#valueForKey" class="headerlink" title="valueForKey:"></a>valueForKey:</h4><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><code class="hljs objc"><span class="hljs-comment">/* Given a key that identifies an attribute or to-one relationship, return the </span><br><span class="hljs-comment">attribute value or the related object. Given a key that identifies a to-many</span><br><span class="hljs-comment"> relationship, return an immutable array or an immutable set that contains all of </span><br><span class="hljs-comment"> the related objects.</span><br><span class="hljs-comment">    </span><br><span class="hljs-comment">The default implementation of this method does the following:</span><br><span class="hljs-comment">    1.Searches the class of the receiver for an accessor method whose name matches</span><br><span class="hljs-comment">     the pattern -get&lt;Key&gt;, -&lt;key&gt;, or -is&lt;Key&gt;, in that order. If such a method</span><br><span class="hljs-comment">    is found it is invoked. If the type of the method&#x27;s result is an object </span><br><span class="hljs-comment">    pointer type the result is simply returned. If the type of the result is one </span><br><span class="hljs-comment">    of the scalar types supported by NSNumber conversion is done and an NSNumber </span><br><span class="hljs-comment">    is returned. Otherwise, conversion is done and an NSValue is returned (new in Mac OS 10.5: results of arbitrary type are converted to NSValues, not just NSPoint, NRange, NSRect, and NSSize).</span><br><span class="hljs-comment">       </span><br><span class="hljs-comment">    2 (introduced in Mac OS 10.7). Otherwise (no simple accessor method is found), </span><br><span class="hljs-comment">    searches the class of the receiver for methods whose names match the patterns </span><br><span class="hljs-comment">    -countOf&lt;Key&gt; and -indexIn&lt;Key&gt;OfObject: and -objectIn&lt;Key&gt;AtIndex: </span><br><span class="hljs-comment">    (corresponding to the primitive methods defined by the NSOrderedSet class) and </span><br><span class="hljs-comment">    also -&lt;key&gt;AtIndexes: (corresponding to -[NSOrderedSet objectsAtIndexes:]). If </span><br><span class="hljs-comment">    a count method and an indexOf method and at least one of the other two </span><br><span class="hljs-comment">    possible methods are found, a collection proxy object that responds to all </span><br><span class="hljs-comment">    NSOrderedSet methods is returned. Each NSOrderedSet message sent to the </span><br><span class="hljs-comment">    collection proxy object will result in some combination of -countOf&lt;Key&gt;,</span><br><span class="hljs-comment">     -indexIn&lt;Key&gt;OfObject:, -objectIn&lt;Key&gt;AtIndex:, and -&lt;key&gt;AtIndexes: messages</span><br><span class="hljs-comment">      being sent to the original receiver of -valueForKey:. If the class of the </span><br><span class="hljs-comment">      receiver also implements an optional method whose name matches the pattern</span><br><span class="hljs-comment">       -get&lt;Key&gt;:range: that method will be used when appropriate for best </span><br><span class="hljs-comment">       performance.</span><br><span class="hljs-comment">       </span><br><span class="hljs-comment">   3 Otherwise (no simple accessor method or set of ordered set access methods </span><br><span class="hljs-comment">    is found), searches the class of the receiver for methods whose names match</span><br><span class="hljs-comment">    the patterns -countOf&lt;Key&gt; and -objectIn&lt;Key&gt;AtIndex: (corresponding to the</span><br><span class="hljs-comment">    primitive methods defined by the NSArray class) and (introduced in Mac OS</span><br><span class="hljs-comment">    10.4) also -&lt;key&gt;AtIndexes: (corresponding to -[NSArray objectsAtIndexes:]).</span><br><span class="hljs-comment">    If a count method and at least one of the other two possible methods are</span><br><span class="hljs-comment">    found, a collection proxy object that responds to all NSArray methods is</span><br><span class="hljs-comment">    returned. Each NSArray message sent to the collection proxy object will result</span><br><span class="hljs-comment">    in some combination of -countOf&lt;Key&gt;, -objectIn&lt;Key&gt;AtIndex:, and</span><br><span class="hljs-comment">    -&lt;key&gt;AtIndexes: messages being sent to the original receiver of</span><br><span class="hljs-comment">    -valueForKey:. If the class of the receiver also implements an optional method </span><br><span class="hljs-comment">    whose name matches the pattern -get&lt;Key&gt;:range: that method will be used when</span><br><span class="hljs-comment">     appropriate for best performance.</span><br><span class="hljs-comment">     </span><br><span class="hljs-comment">    4 (introduced in Mac OS 10.4). Otherwise (no simple accessor method or set of </span><br><span class="hljs-comment">    ordered set or array access methods is found), searches the class of the </span><br><span class="hljs-comment">    receiver for a threesome of methods whose names match the patterns </span><br><span class="hljs-comment">    -countOf&lt;Key&gt;, -enumeratorOf&lt;Key&gt;, and -memberOf&lt;Key&gt;: (corresponding to the </span><br><span class="hljs-comment">    primitive methods defined by the NSSet class). If all three such methods are</span><br><span class="hljs-comment">     found a collection proxy object that responds to all NSSet methods is </span><br><span class="hljs-comment">     returned. Each NSSet message sent to the collection proxy object will result </span><br><span class="hljs-comment">     in some combination of -countOf&lt;Key&gt;, -enumeratorOf&lt;Key&gt;, and -memberOf&lt;Key&gt;:</span><br><span class="hljs-comment">      messages being sent to the original receiver of -valueForKey:.</span><br><span class="hljs-comment">      </span><br><span class="hljs-comment">    5 Otherwise (no simple accessor method or set of collection access methods is</span><br><span class="hljs-comment">     found), if the receiver&#x27;s class&#x27; +accessInstanceVariablesDirectly property</span><br><span class="hljs-comment">    returns YES, searches the class of the receiver for an instance variable whose</span><br><span class="hljs-comment">    name matches the pattern _&lt;key&gt;, _is&lt;Key&gt;, &lt;key&gt;, or is&lt;Key&gt;, in that order.</span><br><span class="hljs-comment">    If such an instance variable is found, the value of the instance variable in</span><br><span class="hljs-comment">    the receiver is returned, with the same sort of conversion to NSNumber or</span><br><span class="hljs-comment">    NSValue as in step 1.</span><br><span class="hljs-comment">    </span><br><span class="hljs-comment">    6 Otherwise (no simple accessor method, set of collection access methods, or</span><br><span class="hljs-comment">    instance variable is found), invokes -valueForUndefinedKey: and returns the</span><br><span class="hljs-comment">    result. The default implementation of -valueForUndefinedKey: raises an</span><br><span class="hljs-comment">    NSUndefinedKeyException, but you can override it in your application.</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">Compatibility notes:</span><br><span class="hljs-comment">    - For backward binary compatibility, an accessor method whose name matches the pattern -_get&lt;Key&gt;, or -_&lt;key&gt; is searched for between steps 1 and 3. If such a method is found it is invoked, with the same sort of conversion to NSNumber or NSValue as in step 1. KVC accessor methods whose names start with underscores were deprecated as of Mac OS 10.3 though.</span><br><span class="hljs-comment">    - The behavior described in step 5 is a change from Mac OS 10.2, in which the instance variable search order was &lt;key&gt;, _&lt;key&gt;.</span><br><span class="hljs-comment">    - For backward binary compatibility, -handleQueryWithUnboundKey: will be invoked instead of -valueForUndefinedKey: in step 6, if the implementation of -handleQueryWithUnboundKey: in the receiver&#x27;s class is not NSObject&#x27;s.</span><br><span class="hljs-comment">*/</span><br>- (<span class="hljs-keyword">nullable</span> <span class="hljs-keyword">id</span>)valueForKey:(<span class="hljs-built_in">NSString</span> *)key;<br></code></pre></td></tr></table></figure>

<p>这个方法的默认实现如下：</p>
<ul>
<li>按照-get<Key>, -<key>, -is<Key>的顺序搜索该类的获取方法，若找到，则直接调用。如果方法调用的结果是id类型，直接把结果返回。如果方法调用的结果是能够被NSNumber转换的标量类型，则结果会被转为NSNumber返回。否则对于一般的标量类型，这些类型将会被转化为NSValue（在Mac OS 10.5及以后，不仅仅支持NSPoint, NRange, NSRect，以及NSSize这些类型</li>
<li>搜索该类的-countOf<Key>, -indexIn<Key>OfObject:方法，还有-objectIn<Key>AtIndex:（对应被NSOrderedSet类所定义的方法），-<key>AtIndexes:（对应-[NSOrderedSet objectsAtIndexes:]）方法。如果-countOf<Key>, -indexIn<Key>OfObject:这两个方法被找到，另外两个方法中的至少一个被找到，那么这个能响应NSOrderedSet所有方法的集合代理对象会被返回。发送给原来消息接收者的-valueForKey:消息，将会被这个集合代理对象的-countOf<Key>, -indexIn<Key>OfObject:, -objectIn<Key>AtIndex:, -<key>AtIndexes:这些方法共同处理。如果这个代理对象也实现了可选的-get<Key>:range:方法，这将有助于增强性能。</li>
<li>搜索该类的-countOf<Key>方法，还有-objectIn<Key>AtIndex:（对应被NSArray类所定义的方法），-<key>AtIndexes:（对应-[NSArray objectsAtIndexes:]）方法。如果-countOf<Key>这个方法被找到，另外两个方法中的至少一个被找到，那么这个能响应NSArray所有方法的集合代理对象会被返回。发送给原来消息接收者的-valueForKey:消息，将会被这个集合代理对象的-countOf<Key>, -objectIn<Key>AtIndex:, -<key>AtIndexes:这些方法共同处理。如果这个代理对象也实现了可选的-get<Key>:range:方法，这将有助于增强性能</li>
<li>搜索-countOf<Key>, -enumeratorOf<Key>, -memberOf<Key>:这些被NSSet类所定义的方法。如果这三个方法都能被找到，那么这个能响应NSSet所有方法的集合代理对象会被返回。发送给原来消息接收者的-valueForKey:消息，将会被这个集合代理对象的countOf<Key>, -enumeratorOf<Key>, -memberOf<Key>:这些方法共同处理。</li>
<li>如果存取器方法、ordered set、array以及set的代理方法都没有被找到，倘若此时消息接收者的+accessInstanceVariablesDirectly属性返回的是YES（默认实现就是返回YES），那么按照_<key>, _is<Key>, <key>, is<Key>的顺序搜索该类的实例变量。如果找到这个实例变量，那么按照步骤1中的类型转换规则返回这个实例变量的值。</li>
<li>调用-valueForUndefinedKey:方法并返回结果。这个方法的默认实现是抛出NSUndefinedKeyException异常，不过你可以重写该方法自行实现。</li>
</ul>
<p>下面我们来验证下上述步骤：</p>
<h5 id="查找key对应的方法"><a href="#查找key对应的方法" class="headerlink" title="查找key对应的方法"></a>查找key对应的方法</h5><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs objc">ViewController.m<br>- (<span class="hljs-keyword">void</span>)valueForKeyTestStep1 &#123;<br>    <span class="hljs-keyword">self</span>.son = [Son new];<br>    <span class="hljs-keyword">id</span> result = [<span class="hljs-keyword">self</span>.son valueForKey:<span class="hljs-string">@&quot;school&quot;</span>];<br>    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;valueForKeyTestStep1 result %@ result class %@&quot;</span>,result,[result <span class="hljs-keyword">class</span>]);<br>&#125;<br><br>Son.m<br><span class="hljs-meta">#<span class="hljs-meta-keyword">pragma</span> mark - valueForKey</span><br><span class="hljs-comment">// 优先级由高到低</span><br>- (<span class="hljs-built_in">NSString</span> *)getSchool &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-string">@&quot;Beijiing&quot;</span>;<br>&#125;<br><br>- (<span class="hljs-built_in">NSString</span> *)school &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-string">@&quot;Shanghai&quot;</span>;<br>&#125;<br><br>- (<span class="hljs-built_in">NSString</span> *)isSchool &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-string">@&quot;HongKong&quot;</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>控制台输出</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs objc"><span class="hljs-number">2020</span><span class="hljs-number">-12</span><span class="hljs-number">-26</span> <span class="hljs-number">20</span>:<span class="hljs-number">45</span>:<span class="hljs-number">27.422284</span>+<span class="hljs-number">0800</span> Runtime-KVC[<span class="hljs-number">47753</span>:<span class="hljs-number">19135113</span>] valueForKeyTestStep1 result HongKong result <span class="hljs-keyword">class</span> __NSCFConstantString<br></code></pre></td></tr></table></figure>

<p>我们可以通过依次注释上述三个方法，控制台输出分别为:<code>Beijiing</code>、<code>Shanghai</code>、<code>HongKong</code>,如果三个方法都注释了，那么程序会因为找不到key对应的value而crash</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs objc">libc++abi.dylib: terminating with uncaught exception of type <span class="hljs-built_in">NSException</span><br>*** Terminating app due to uncaught exception <span class="hljs-string">&#x27;NSUnknownKeyException&#x27;</span>, reason: <span class="hljs-string">&#x27;[&lt;Son 0x600003707240&gt; valueForUndefinedKey:]: this class is not key value coding-compliant for the key school.&#x27;</span><br>terminating with uncaught exception of type <span class="hljs-built_in">NSException</span><br></code></pre></td></tr></table></figure>

<h5 id="搜索集合类型相关方法"><a href="#搜索集合类型相关方法" class="headerlink" title="搜索集合类型相关方法"></a>搜索集合类型相关方法</h5><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs objc"><br>ViewController.m<br><br>- (<span class="hljs-keyword">void</span>)valueForKeyTestStep2 &#123;<br>    <span class="hljs-keyword">self</span>.son = [Son new];<br>    <span class="hljs-keyword">id</span> result = [<span class="hljs-keyword">self</span>.son valueForKey:<span class="hljs-string">@&quot;school&quot;</span>];<br>    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;valueForKeyTestStep2 result %@ result class %@&quot;</span>,result,[result <span class="hljs-keyword">class</span>]);<br>&#125;<br><br>Son.m<br><br><span class="hljs-comment">// school key 对应的值有几个</span><br>- (<span class="hljs-built_in">NSInteger</span>)countOfSchool &#123;<br>    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;countOfSchool&quot;</span>);<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">2</span>;<br>&#125;<br><br><span class="hljs-comment">// school对应index是多少</span><br>- (<span class="hljs-built_in">NSInteger</span>)indexInSchoolOfObject:(<span class="hljs-built_in">NSString</span> *)school &#123;<br>    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;indexInSchoolOfObject %@&quot;</span>,school);<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;<br>&#125;<br><br><span class="hljs-comment">// index 下标对应的值是多少</span><br>- (<span class="hljs-built_in">NSString</span> *)objectInSchoolAtIndex:(<span class="hljs-built_in">NSInteger</span>)index &#123;<br>    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;objectInSchoolAtIndex %@&quot;</span>,@(index));<br>    <span class="hljs-keyword">if</span> (index % <span class="hljs-number">2</span> == <span class="hljs-number">0</span>) &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">@&quot;Beijing&quot;</span>;<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">@&quot;HongKong&quot;</span>;<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>

<p>控制台输出：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs objc"><span class="hljs-number">12</span><span class="hljs-number">-26</span> <span class="hljs-number">20</span>:<span class="hljs-number">58</span>:<span class="hljs-number">29.557431</span>+<span class="hljs-number">0800</span> Runtime-KVC[<span class="hljs-number">48005</span>:<span class="hljs-number">19146834</span>] countOfSchool<br><span class="hljs-number">2020</span><span class="hljs-number">-12</span><span class="hljs-number">-26</span> <span class="hljs-number">20</span>:<span class="hljs-number">58</span>:<span class="hljs-number">29.557542</span>+<span class="hljs-number">0800</span> Runtime-KVC[<span class="hljs-number">48005</span>:<span class="hljs-number">19146834</span>] countOfSchool<br><span class="hljs-number">2020</span><span class="hljs-number">-12</span><span class="hljs-number">-26</span> <span class="hljs-number">20</span>:<span class="hljs-number">58</span>:<span class="hljs-number">29.557652</span>+<span class="hljs-number">0800</span> Runtime-KVC[<span class="hljs-number">48005</span>:<span class="hljs-number">19146834</span>] objectInSchoolAtIndex <span class="hljs-number">0</span><br><span class="hljs-number">2020</span><span class="hljs-number">-12</span><span class="hljs-number">-26</span> <span class="hljs-number">20</span>:<span class="hljs-number">58</span>:<span class="hljs-number">29.557739</span>+<span class="hljs-number">0800</span> Runtime-KVC[<span class="hljs-number">48005</span>:<span class="hljs-number">19146834</span>] objectInSchoolAtIndex <span class="hljs-number">1</span><br><span class="hljs-number">2020</span><span class="hljs-number">-12</span><span class="hljs-number">-26</span> <span class="hljs-number">20</span>:<span class="hljs-number">58</span>:<span class="hljs-number">29.557856</span>+<span class="hljs-number">0800</span> Runtime-KVC[<span class="hljs-number">48005</span>:<span class="hljs-number">19146834</span>] valueForKeyTestStep2 result &#123;(<br>    Beijing,<br>    HongKong<br>)&#125; result <span class="hljs-keyword">class</span> <span class="hljs-built_in">NSKeyValueOrderedSet</span><br></code></pre></td></tr></table></figure>

<p>从上面的打印结果来看，实际上并非如API所说:<code>indexInSchoolOfObject</code>为必须实现，<code>因为我们在调用valueForKey时并未调用到该方法</code>。数据结果也验证了countOfSchool表示key对应的集合value有几个值，每个index对应的值为什么。从最终打印结果看valueForKey最终返回的是<code>NSKeyValueOrderedSet</code></p>
<h5 id="NSArray-搜索数组相关方法"><a href="#NSArray-搜索数组相关方法" class="headerlink" title="NSArray 搜索数组相关方法"></a>NSArray 搜索数组相关方法</h5><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs objc">ViewController.m <br><br>- (<span class="hljs-keyword">void</span>)valueForKeyTestStep3 &#123;<br>    <span class="hljs-keyword">self</span>.son = [Son new];<br>    <span class="hljs-keyword">id</span> result = [<span class="hljs-keyword">self</span>.son valueForKey:<span class="hljs-string">@&quot;school&quot;</span>];<br>    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;valueForKeyTestStep3 result %@ result class %@&quot;</span>,result,[result <span class="hljs-keyword">class</span>]);<br>&#125;<br><br>Son.m<br><br>- (<span class="hljs-built_in">NSInteger</span>)countOfSchool &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">3</span>;<br>&#125;<br><br>- (<span class="hljs-built_in">NSString</span> *)objectInSchoolAtIndex:(<span class="hljs-built_in">NSInteger</span>)index &#123;<br>    <span class="hljs-keyword">if</span> (index % <span class="hljs-number">2</span> == <span class="hljs-number">0</span>) &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">@&quot;Beijing&quot;</span>;<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">@&quot;HongKong&quot;</span>;<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>

<p>控制台输出结果:</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs objc"><span class="hljs-number">2020</span><span class="hljs-number">-12</span><span class="hljs-number">-26</span> <span class="hljs-number">21</span>:<span class="hljs-number">00</span>:<span class="hljs-number">54.850506</span>+<span class="hljs-number">0800</span> Runtime-KVC[<span class="hljs-number">48058</span>:<span class="hljs-number">19149212</span>] countOfSchool<br><span class="hljs-number">2020</span><span class="hljs-number">-12</span><span class="hljs-number">-26</span> <span class="hljs-number">21</span>:<span class="hljs-number">00</span>:<span class="hljs-number">54.850608</span>+<span class="hljs-number">0800</span> Runtime-KVC[<span class="hljs-number">48058</span>:<span class="hljs-number">19149212</span>] countOfSchool<br><span class="hljs-number">2020</span><span class="hljs-number">-12</span><span class="hljs-number">-26</span> <span class="hljs-number">21</span>:<span class="hljs-number">00</span>:<span class="hljs-number">54.850710</span>+<span class="hljs-number">0800</span> Runtime-KVC[<span class="hljs-number">48058</span>:<span class="hljs-number">19149212</span>] objectInSchoolAtIndex <span class="hljs-number">0</span><br><span class="hljs-number">2020</span><span class="hljs-number">-12</span><span class="hljs-number">-26</span> <span class="hljs-number">21</span>:<span class="hljs-number">00</span>:<span class="hljs-number">54.850815</span>+<span class="hljs-number">0800</span> Runtime-KVC[<span class="hljs-number">48058</span>:<span class="hljs-number">19149212</span>] objectInSchoolAtIndex <span class="hljs-number">1</span><br><span class="hljs-number">2020</span><span class="hljs-number">-12</span><span class="hljs-number">-26</span> <span class="hljs-number">21</span>:<span class="hljs-number">00</span>:<span class="hljs-number">54.850920</span>+<span class="hljs-number">0800</span> Runtime-KVC[<span class="hljs-number">48058</span>:<span class="hljs-number">19149212</span>] objectInSchoolAtIndex <span class="hljs-number">2</span><br><span class="hljs-number">2020</span><span class="hljs-number">-12</span><span class="hljs-number">-26</span> <span class="hljs-number">21</span>:<span class="hljs-number">00</span>:<span class="hljs-number">54.851031</span>+<span class="hljs-number">0800</span> Runtime-KVC[<span class="hljs-number">48058</span>:<span class="hljs-number">19149212</span>] valueForKeyTestStep3 result (<br>    Beijing,<br>    HongKong,<br>    Beijing<br>) result <span class="hljs-keyword">class</span> <span class="hljs-built_in">NSKeyValueArray</span><br></code></pre></td></tr></table></figure>

<p>与上面NSKeyValueOrderedSet集合类似，本次搜索方法返回的结果为NSKeyValueArray即数组类型，countOfSchool表示返回的数组中有几个元素，objectInSchoolAtIndex表示返回的数组每个元素是什么,valueForKey最终返回的是数组和数组中的每一个元素。</p>
<h5 id="NSSet-相关搜索方法"><a href="#NSSet-相关搜索方法" class="headerlink" title="NSSet 相关搜索方法"></a>NSSet 相关搜索方法</h5><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs objc">ViewController.m<br><br>- (<span class="hljs-keyword">void</span>)valueForKeyTestStep4 &#123;<br>    <span class="hljs-keyword">self</span>.son = [Son new];<br>    <span class="hljs-keyword">id</span> result = [<span class="hljs-keyword">self</span>.son valueForKey:<span class="hljs-string">@&quot;school&quot;</span>];<br>    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;valueForKeyTestStep4 result %@ result class %@&quot;</span>,result,[result <span class="hljs-keyword">class</span>]);<br>&#125;<br><br>Son.m<br>- (<span class="hljs-built_in">NSInteger</span>)countOfSchool &#123;<br>    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;countOfSchool&quot;</span>);<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">2</span>;<br>&#125;<br><br>- (<span class="hljs-built_in">NSEnumerator</span>&lt;<span class="hljs-keyword">id</span>&gt; *)enumeratorOfSchool &#123;<br>    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;objectInSchoolAtIndex &quot;</span>);<br>    <span class="hljs-built_in">NSSet</span> *schools = [<span class="hljs-built_in">NSSet</span> setWithArray:@[<span class="hljs-string">@&quot;Beijing&quot;</span>,<span class="hljs-string">@&quot;Hongkong&quot;</span>]];<br>    <span class="hljs-keyword">return</span> [schools objectEnumerator];<br>&#125;<br><br>- (<span class="hljs-built_in">BOOL</span>)memberOfSchool:(<span class="hljs-built_in">NSString</span> *)school &#123;<br>    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;memberOfSchool %@&quot;</span>,school);<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">YES</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>控制台输出:</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs objc"><span class="hljs-number">2020</span><span class="hljs-number">-12</span><span class="hljs-number">-26</span> <span class="hljs-number">21</span>:<span class="hljs-number">24</span>:<span class="hljs-number">41.942115</span>+<span class="hljs-number">0800</span> Runtime-KVC[<span class="hljs-number">48572</span>:<span class="hljs-number">19174700</span>] countOfSchool<br><span class="hljs-number">2020</span><span class="hljs-number">-12</span><span class="hljs-number">-26</span> <span class="hljs-number">21</span>:<span class="hljs-number">24</span>:<span class="hljs-number">41.942285</span>+<span class="hljs-number">0800</span> Runtime-KVC[<span class="hljs-number">48572</span>:<span class="hljs-number">19174700</span>] countOfSchool<br><span class="hljs-number">2020</span><span class="hljs-number">-12</span><span class="hljs-number">-26</span> <span class="hljs-number">21</span>:<span class="hljs-number">24</span>:<span class="hljs-number">41.942370</span>+<span class="hljs-number">0800</span> Runtime-KVC[<span class="hljs-number">48572</span>:<span class="hljs-number">19174700</span>] objectInSchoolAtIndex<br><span class="hljs-number">2020</span><span class="hljs-number">-12</span><span class="hljs-number">-26</span> <span class="hljs-number">21</span>:<span class="hljs-number">24</span>:<span class="hljs-number">41.942503</span>+<span class="hljs-number">0800</span> Runtime-KVC[<span class="hljs-number">48572</span>:<span class="hljs-number">19174700</span>] valueForKeyTestStep4 result &#123;(<br>    Beijing,<br>    Hongkong<br>)&#125; result <span class="hljs-keyword">class</span> <span class="hljs-built_in">NSKeyValueSet</span><br></code></pre></td></tr></table></figure>

<p><code>countOfSchool</code>和<code>enumeratorOfSchool</code>两个方法比较好理解，表示school的个数和school集合的遍历器。memberOfSchool实际并未清楚到底是什么意思，这里有两种猜想</p>
<ul>
<li>是否是某个类型</li>
<li>是否是集合中的对象</li>
</ul>
<p>当我们去掉这个方法的实现时,会直接崩溃</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs objc">libc++abi.dylib: terminating with uncaught exception of type <span class="hljs-built_in">NSException</span><br>*** Terminating app due to uncaught exception <span class="hljs-string">&#x27;NSUnknownKeyException&#x27;</span>, reason: <span class="hljs-string">&#x27;[&lt;Son 0x60000298fdc0&gt; valueForUndefinedKey:]: this class is not key value coding-compliant for the key school.&#x27;</span><br>terminating with uncaught exception of type <span class="hljs-built_in">NSException</span><br></code></pre></td></tr></table></figure>

<p>当我们将这个方法的实现改为：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs objc">- (<span class="hljs-keyword">void</span>)memberOfSchool:(<span class="hljs-built_in">NSString</span> *)school &#123;<br>    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;memberOfSchool %@&quot;</span>,school);<br><span class="hljs-comment">//    return YES;</span><br>&#125;<br></code></pre></td></tr></table></figure>
<p>依然得到与上述相同的结果，因此这里无法判断这个方法的实现应该是什么样的</p>
<h5 id="搜索实例变量"><a href="#搜索实例变量" class="headerlink" title="搜索实例变量"></a>搜索实例变量</h5><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs objc">ViewController.m<br><br>- (<span class="hljs-keyword">void</span>)valueForKeyTestStep5 &#123;<br>    <span class="hljs-keyword">self</span>.son = [Son new];<br>    <span class="hljs-keyword">id</span> result = [<span class="hljs-keyword">self</span>.son valueForKey:<span class="hljs-string">@&quot;school&quot;</span>];<br>    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;valueForKeyTestStep5 result %@ result class %@&quot;</span>,result,[result <span class="hljs-keyword">class</span>]);<br>&#125;<br><br>Son.m<br><br>- (<span class="hljs-keyword">instancetype</span>)init &#123;<br>    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">self</span> = [<span class="hljs-keyword">super</span> init]) &#123;<br>        _isSchool = <span class="hljs-string">@&quot;Beijing&quot;</span>;<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">self</span>;<br>&#125;<br><br>+ (<span class="hljs-built_in">BOOL</span>)accessInstanceVariablesDirectly &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">YES</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>控制台输出:</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs objc"><span class="hljs-number">2020</span><span class="hljs-number">-12</span><span class="hljs-number">-26</span> <span class="hljs-number">21</span>:<span class="hljs-number">29</span>:<span class="hljs-number">52.568972</span>+<span class="hljs-number">0800</span> Runtime-KVC[<span class="hljs-number">48691</span>:<span class="hljs-number">19180589</span>] valueForKeyTestStep5 result Beijing result <span class="hljs-keyword">class</span> __NSCFConstantString<br></code></pre></td></tr></table></figure>

<p>这里我们定义了一个实例变量_isSchool,valueForKey方法在搜索集合相关属性无果后，会查找是否存在对应名称的实例变量，如果找到对应的实例变量，则返回。</p>
<h5 id="valueForUndefinedKey"><a href="#valueForUndefinedKey" class="headerlink" title="valueForUndefinedKey"></a>valueForUndefinedKey</h5><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs objc">- (<span class="hljs-keyword">void</span>)valueForKeyTestStep6 &#123;<br>    <span class="hljs-keyword">self</span>.son = [Son new];<br>    <span class="hljs-keyword">id</span> result = [<span class="hljs-keyword">self</span>.son valueForKey:<span class="hljs-string">@&quot;school&quot;</span>];<br>    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;valueForKeyTestStep6 result %@ result class %@&quot;</span>,result,[result <span class="hljs-keyword">class</span>]);<br>&#125;<br><br>- (<span class="hljs-keyword">id</span>)valueForUndefinedKey:(<span class="hljs-built_in">NSString</span> *)key &#123;<br>    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;valueForUndefinedKey %@&quot;</span>,key);<br>    <span class="hljs-keyword">return</span> <span class="hljs-string">@&quot;Beijing&quot;</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>控制台输出:</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs objc"><span class="hljs-number">2020</span><span class="hljs-number">-12</span><span class="hljs-number">-26</span> <span class="hljs-number">21</span>:<span class="hljs-number">35</span>:<span class="hljs-number">16.596774</span>+<span class="hljs-number">0800</span> Runtime-KVC[<span class="hljs-number">48788</span>:<span class="hljs-number">19185406</span>] valueForUndefinedKey school<br><span class="hljs-number">2020</span><span class="hljs-number">-12</span><span class="hljs-number">-26</span> <span class="hljs-number">21</span>:<span class="hljs-number">35</span>:<span class="hljs-number">20.486420</span>+<span class="hljs-number">0800</span> Runtime-KVC[<span class="hljs-number">48788</span>:<span class="hljs-number">19185406</span>] valueForKeyTestStep6 result Beijing result <span class="hljs-keyword">class</span> __NSCFConstantString<br></code></pre></td></tr></table></figure>

<p>当上述5步均无法找到对应方法，那么系统最终会调用valueForUndefinedKey方法，这个方法的默认实现就是上面我们贴的崩溃，不过我们可以重写这个方法，并在这个方法中记录对应的key值并返回一个默认值。</p>
<p>综上我们可以总结valueForKey方法调用的流程实际上是一个方法查找的流程，具体如下图</p>
<p><img src="https://tva1.sinaimg.cn/large/0081Kckwly1gm1lwez70ij30u01gx110.jpg"></p>
<h3 id="集合类型"><a href="#集合类型" class="headerlink" title="集合类型"></a>集合类型</h3><p>KVC除了上述对于所有对象都适用的设置方法setValue:forKey:和获取方法valueForKey:外还有专门对于集合类型对象的方法</p>
<ul>
<li>mutableArrayValueForKey:</li>
<li>mutableOrderedSetValueForKey:</li>
<li>mutableSetValueForKey:</li>
</ul>
<p>这里我们拿mutableArrayValueForKey方法举例说明</p>
<p>同样我们先来看下方法的API说明</p>
<h4 id="mutableArrayValueForKey"><a href="#mutableArrayValueForKey" class="headerlink" title="mutableArrayValueForKey"></a>mutableArrayValueForKey</h4><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><code class="hljs objc"><span class="hljs-comment">/* Given a key that identifies an _ordered_ to-many relationship, return a mutable </span><br><span class="hljs-comment">array that provides read-write access to the related objects. Objects added to the </span><br><span class="hljs-comment">mutable array will become related to the receiver, and objects removed from the </span><br><span class="hljs-comment">mutable array will become unrelated.</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">The default implementation of this method recognizes the same simple accessor </span><br><span class="hljs-comment">methods and array accessor methods as -valueForKey:&#x27;s, and follows the same direct</span><br><span class="hljs-comment">instance variable access policies, but always returns a mutable collection proxy </span><br><span class="hljs-comment">object instead of the immutable collection that -valueForKey: would return. It</span><br><span class="hljs-comment">also:</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">    1 Searches the class of the receiver for methods whose names match the</span><br><span class="hljs-comment">    patterns -insertObject:in&lt;Key&gt;AtIndex: and -removeObjectFrom&lt;Key&gt;AtIndex:</span><br><span class="hljs-comment">    (corresponding to the two most primitive methods defined by the NSMutableArray</span><br><span class="hljs-comment">    class), and (introduced in Mac OS 10.4) also -insert&lt;Key&gt;:atIndexes: and</span><br><span class="hljs-comment">    -remove&lt;Key&gt;AtIndexes: (corresponding to -[NSMutableArray</span><br><span class="hljs-comment">    insertObjects:atIndexes:] and -[NSMutableArray removeObjectsAtIndexes:). </span><br><span class="hljs-comment">    If at least one insertion method and at least one removal method are found</span><br><span class="hljs-comment">    each NSMutableArray message sent to the collection proxy object will result</span><br><span class="hljs-comment">    in some combination of -insertObject:in&lt;Key&gt;AtIndex:,</span><br><span class="hljs-comment">    -removeObjectFrom&lt;Key&gt;AtIndex:, -insert&lt;Key&gt;:atIndexes:, and</span><br><span class="hljs-comment">    -remove&lt;Key&gt;AtIndexes: messages being sent to the original receiver of</span><br><span class="hljs-comment">    -mutableArrayValueForKey:. If the class of the receiver also implements an</span><br><span class="hljs-comment">    optional method whose name matches the pattern</span><br><span class="hljs-comment">    -replaceObjectIn&lt;Key&gt;AtIndex:withObject: or (introduced in Mac OS 10.4)</span><br><span class="hljs-comment">    -replace&lt;Key&gt;AtIndexes:with&lt;Key&gt;: that method will be used when appropriate</span><br><span class="hljs-comment">    for best performance.</span><br><span class="hljs-comment">    </span><br><span class="hljs-comment">    2 Otherwise (no set of array mutation methods is found), searches the class of</span><br><span class="hljs-comment">    the receiver for an accessor method whose name matches the pattern -set&lt;Key&gt;:.</span><br><span class="hljs-comment">    If such a method is found each NSMutableArray message sent to the collection</span><br><span class="hljs-comment">    proxy object will result in a -set&lt;Key&gt;: message being sent to the original</span><br><span class="hljs-comment">    receiver of -mutableArrayValueForKey:.</span><br><span class="hljs-comment">    </span><br><span class="hljs-comment">    3 Otherwise (no set of array mutation methods or simple accessor method is</span><br><span class="hljs-comment">    found), if the receiver&#x27;s class&#x27; +accessInstanceVariablesDirectly property</span><br><span class="hljs-comment">    returns YES, searches the class of the receiver for an instance variable whose</span><br><span class="hljs-comment">    name matches the pattern _&lt;key&gt; or &lt;key&gt;, in that order. If such an instance</span><br><span class="hljs-comment">    variable is found, each NSMutableArray message sent to the collection proxy</span><br><span class="hljs-comment">    object will be forwarded to the instance variable&#x27;s value, which therefore</span><br><span class="hljs-comment">    must typically be an instance of NSMutableArray or a subclass of </span><br><span class="hljs-comment">    NSMutableArray.</span><br><span class="hljs-comment">    </span><br><span class="hljs-comment">    4 Otherwise (no set of array mutation methods, simple accessor method, or</span><br><span class="hljs-comment">    instance variable is found), returns a mutable collection proxy object anyway.</span><br><span class="hljs-comment">    Each NSMutableArray message sent to the collection proxy object will result in</span><br><span class="hljs-comment">    a -setValue:forUndefinedKey: message being sent to the original receiver of</span><br><span class="hljs-comment">    -mutableArrayValueForKey:. The default implementation of</span><br><span class="hljs-comment">    -setValue:forUndefinedKey: raises an NSUndefinedKeyException, but you can</span><br><span class="hljs-comment">    override it in your application.</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">Performance note: the repetitive -set&lt;Key&gt;: messages implied by step 2&#x27;s description are a potential performance problem. For better performance implement insertion and removal methods that fulfill the requirements for step 1 in your KVC-compliant class. For best performance implement a replacement method too.</span><br><span class="hljs-comment">*/</span><br>- (<span class="hljs-built_in">NSMutableArray</span> *)mutableArrayValueForKey:(<span class="hljs-built_in">NSString</span> *)key;<br></code></pre></td></tr></table></figure>

<p>该方法的查找路径为：</p>
<ul>
<li>查找类中是否有-insertObject:in<Key>AtIndex:和-removeObjectFrom<Key>AtIndex:(同NSMutableArray的-insert<Key>:atIndexes:和-removeObjectFrom<Key>AtIndex:方法)，如果找到至少一个insert和至少一个remove方法。</li>
<li>查找类中是否有-set<Key>:方法，如果有则调用这个方法进行赋值</li>
<li>accessInstanceVariablesDirectly方法是否返回YES，如果返回YES查找类中是否有对应名称为_<key> 或者 <key> 的成员变量(必须是NSMutableArray或者子类) 给其赋值</li>
<li>调用-setValue:forUndefinedKey:方法默认为NSUndefinedKeyException的crash</li>
</ul>
<h4 id="疑问？"><a href="#疑问？" class="headerlink" title="疑问？"></a>疑问？</h4><p>在尝试写测试代码时，按照valueForKey:方法的实现想法，我们通过mutableArrayValueForKey获取一个可变数组然后进行增删改查。</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs objc">- (<span class="hljs-keyword">void</span>)mutableArrayValueForKey &#123;<br>    <span class="hljs-keyword">self</span>.father = [Father new];<br>    [[<span class="hljs-keyword">self</span>.father mutableArrayValueForKey:<span class="hljs-string">@&quot;children&quot;</span>] addObject:<span class="hljs-string">@&quot;farmer&quot;</span>];<br>    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;mutableArrayValueForKey -- addObject %@&quot;</span>,[<span class="hljs-keyword">self</span>.father mutableArrayValueForKey:<span class="hljs-string">@&quot;children&quot;</span>].firstObject);<br>    [[<span class="hljs-keyword">self</span>.father mutableArrayValueForKey:<span class="hljs-string">@&quot;children&quot;</span>] removeObjectAtIndex:<span class="hljs-number">0</span>];<br>    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;mutableArrayValueForKey -- removeObject %@&quot;</span>,[<span class="hljs-keyword">self</span>.father mutableArrayValueForKey:<span class="hljs-string">@&quot;children&quot;</span>]);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>当我直接运行上述代码时，Demo直接crash</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs objc"><span class="hljs-number">2020</span><span class="hljs-number">-12</span><span class="hljs-number">-26</span> <span class="hljs-number">23</span>:<span class="hljs-number">36</span>:<span class="hljs-number">46.702341</span>+<span class="hljs-number">0800</span> Runtime-KVC[<span class="hljs-number">51145</span>:<span class="hljs-number">19283102</span>] *** Terminating app due to uncaught exception <span class="hljs-string">&#x27;NSUnknownKeyException&#x27;</span>, reason: <span class="hljs-string">&#x27;[&lt;Father 0x6000004dd260&gt; valueForUndefinedKey:]: this class is not key value coding-compliant for the key children.&#x27;</span><br></code></pre></td></tr></table></figure>
<p>valueForUndefinedKey 这里提示我们father类中没有children这个属性，但是在使用valueForKey时，我们即使key值是一个有问题的但并不影响我们的操作，我们依然可以实现数据的存取。但是这里就不可以! 如果有了解的同学可以给我留言，万分感谢。</p>
<h4 id="mutableArrayValueForKey-amp-KVO"><a href="#mutableArrayValueForKey-amp-KVO" class="headerlink" title="mutableArrayValueForKey&amp;KVO"></a>mutableArrayValueForKey&amp;KVO</h4><p>在网上搜索这个方法的使用时，大部分都提到与KVO一起使用,下面我们来看下这个例子:</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><code class="hljs objc"><span class="hljs-class"><span class="hljs-keyword">@interface</span> <span class="hljs-title">Father</span> : <span class="hljs-title">Person</span></span><br><span class="hljs-keyword">@property</span> (<span class="hljs-keyword">nonatomic</span>, <span class="hljs-keyword">strong</span>) <span class="hljs-built_in">NSMutableArray</span> *children;<br><span class="hljs-keyword">@end</span><br><br><span class="hljs-class"><span class="hljs-keyword">@implementation</span> <span class="hljs-title">Father</span></span><br><br>- (<span class="hljs-keyword">instancetype</span>)init &#123;<br>    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">self</span> = [<span class="hljs-keyword">super</span> init]) &#123;<br>        _children = [<span class="hljs-built_in">NSMutableArray</span> array];<br>        [<span class="hljs-keyword">self</span> addObserver];<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">self</span>;<br>&#125;<br><br>- (<span class="hljs-keyword">void</span>)addObserver &#123;<br>    [<span class="hljs-keyword">self</span> addObserver:<span class="hljs-keyword">self</span> forKeyPath:<span class="hljs-string">@&quot;children&quot;</span> options:<span class="hljs-built_in">NSKeyValueObservingOptionNew</span> | <span class="hljs-built_in">NSKeyValueObservingOptionOld</span> context:<span class="hljs-literal">nil</span>];<br>&#125;<br><br>- (<span class="hljs-keyword">void</span>)removeObserver &#123;<br>    [<span class="hljs-keyword">self</span> removeObserver:<span class="hljs-keyword">self</span> forKeyPath:<span class="hljs-string">@&quot;children&quot;</span>];<br>&#125;<br><br>- (<span class="hljs-keyword">void</span>)dealloc &#123;<br>    [<span class="hljs-keyword">self</span> removeObserver];<br>&#125;<br><br>- (<span class="hljs-keyword">void</span>)observeValueForKeyPath:(<span class="hljs-built_in">NSString</span> *)keyPath ofObject:(<span class="hljs-keyword">id</span>)object change:(<span class="hljs-built_in">NSDictionary</span>&lt;<span class="hljs-built_in">NSKeyValueChangeKey</span>,<span class="hljs-keyword">id</span>&gt; *)change context:(<span class="hljs-keyword">void</span> *)context &#123;<br>    <span class="hljs-keyword">if</span> ([keyPath isEqualToString:<span class="hljs-string">@&quot;children&quot;</span>]) &#123;<br>        <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;%@&quot;</span>,change);<br>    &#125;<br>&#125;<br><span class="hljs-keyword">@end</span><br><br><br><span class="hljs-comment">// 外部使用</span><br>- (<span class="hljs-keyword">void</span>)mutableArrayValueForKey &#123;<br>    <span class="hljs-keyword">self</span>.father = [Father new];<br>    [<span class="hljs-keyword">self</span>.father.children addObject:<span class="hljs-string">@&quot;son1&quot;</span>];<br>&#125;<br><br></code></pre></td></tr></table></figure>

<p>控制台输出为空，这里可以看出即使我们添加了KVO监听数组的变化我们仍无法在数组元素改变时监听到数组改变。</p>
<p>但是当我们把调用改为</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs objc">- (<span class="hljs-keyword">void</span>)mutableArrayValueForKey &#123;<br>    <span class="hljs-keyword">self</span>.father = [Father new];<br>    [[<span class="hljs-keyword">self</span>.father mutableArrayValueForKey:<span class="hljs-string">@&quot;children&quot;</span>] addObject:<span class="hljs-string">@&quot;farmer&quot;</span>];<br>&#125;<br></code></pre></td></tr></table></figure>

<p>控制台输出变为:</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs objc"><span class="hljs-number">2020</span><span class="hljs-number">-12</span><span class="hljs-number">-26</span> <span class="hljs-number">23</span>:<span class="hljs-number">52</span>:<span class="hljs-number">17.776620</span>+<span class="hljs-number">0800</span> Runtime-KVC[<span class="hljs-number">51402</span>:<span class="hljs-number">19295413</span>] insertObject: farmer inChildrenAtIndex: <span class="hljs-number">1</span><br><span class="hljs-number">2020</span><span class="hljs-number">-12</span><span class="hljs-number">-26</span> <span class="hljs-number">23</span>:<span class="hljs-number">52</span>:<span class="hljs-number">17.776865</span>+<span class="hljs-number">0800</span> Runtime-KVC[<span class="hljs-number">51402</span>:<span class="hljs-number">19295413</span>] &#123;<br>    indexes = <span class="hljs-string">&quot;&lt;_NSCachedIndexSet: 0x600003278320&gt;[number of indexes: 1 (in 1 ranges), indexes: (1)]&quot;</span>;<br>    kind = <span class="hljs-number">2</span>;<br>    new =     (<br>        farmer<br>    );<br>&#125;<br></code></pre></td></tr></table></figure>

<p>显然通过mutableArrayValueForKey方法获取father对象的children数组时触发了KVO对数组的监听。在联想到mutableArrayValueForKey查找路径,因为默认我们没有实现第一步查找的方法会自动走到第二步通过setKey方法进行赋值，而KVO的实现原理就是通过重写Set方法进行监听，因此我们使用mutableArrayValueForKey就可以实现对数组的监听。</p>
<p>同样我们可以使用下面的方式验证：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs objc">- (<span class="hljs-keyword">void</span>)mutableArrayValueForKey &#123;<br>    <span class="hljs-keyword">self</span>.father = [Father new];<br>    [<span class="hljs-keyword">self</span>.father.children addObject:<span class="hljs-string">@&quot;son1&quot;</span>];<br>    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;befor ---- children = %p&quot;</span>,<span class="hljs-keyword">self</span>.father.children);<br>    [[<span class="hljs-keyword">self</span>.father mutableArrayValueForKey:<span class="hljs-string">@&quot;children&quot;</span>] addObject:<span class="hljs-string">@&quot;farmer&quot;</span>];<br>    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;after ---- children = %p&quot;</span>,<span class="hljs-keyword">self</span>.father.children);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>控制台输出结果:</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs objc"><span class="hljs-number">2020</span><span class="hljs-number">-12</span><span class="hljs-number">-27</span> <span class="hljs-number">00</span>:<span class="hljs-number">07</span>:<span class="hljs-number">09.558349</span>+<span class="hljs-number">0800</span> Runtime-KVC[<span class="hljs-number">51645</span>:<span class="hljs-number">19310184</span>] befor ---- children = <span class="hljs-number">0x600000a81020</span><br><span class="hljs-number">2020</span><span class="hljs-number">-12</span><span class="hljs-number">-27</span> <span class="hljs-number">00</span>:<span class="hljs-number">07</span>:<span class="hljs-number">09.558632</span>+<span class="hljs-number">0800</span> Runtime-KVC[<span class="hljs-number">51645</span>:<span class="hljs-number">19310184</span>] &#123;<br>    indexes = <span class="hljs-string">&quot;&lt;_NSCachedIndexSet: 0x6000004d0ca0&gt;[number of indexes: 1 (in 1 ranges), indexes: (1)]&quot;</span>;<br>    kind = <span class="hljs-number">2</span>;<br>    new =     (<br>        farmer<br>    );<br>&#125;<br><span class="hljs-number">2020</span><span class="hljs-number">-12</span><span class="hljs-number">-27</span> <span class="hljs-number">00</span>:<span class="hljs-number">07</span>:<span class="hljs-number">09.558717</span>+<span class="hljs-number">0800</span> Runtime-KVC[<span class="hljs-number">51645</span>:<span class="hljs-number">19310184</span>] after ---- children = <span class="hljs-number">0x600000a80f90</span><br></code></pre></td></tr></table></figure>
<p>从打印结果我们可以看出在调用了mutableArrayValueForKey方法后，self.father.children的对象地址就发生了改变。</p>
<p>加入我们再想数组中继续添加数据</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs objc">- (<span class="hljs-keyword">void</span>)mutableArrayValueForKey &#123;<br>    <span class="hljs-keyword">self</span>.father = [Father new];<br>    [<span class="hljs-keyword">self</span>.father.children addObject:<span class="hljs-string">@&quot;son1&quot;</span>];<br>    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;befor ---- children = %p  children class %@&quot;</span>,<span class="hljs-keyword">self</span>.father.children,[<span class="hljs-keyword">self</span>.father.children <span class="hljs-keyword">class</span>]);<br>    [[<span class="hljs-keyword">self</span>.father mutableArrayValueForKey:<span class="hljs-string">@&quot;children&quot;</span>] addObject:<span class="hljs-string">@&quot;farmer&quot;</span>];<br>    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;after ---- children = %p  children class %@&quot;</span>,<span class="hljs-keyword">self</span>.father.children,[<span class="hljs-keyword">self</span>.father.children <span class="hljs-keyword">class</span>]);<br>    [[<span class="hljs-keyword">self</span>.father mutableArrayValueForKey:<span class="hljs-string">@&quot;children&quot;</span>] addObject:<span class="hljs-string">@&quot;air&quot;</span>];<br>    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;after ---- children = %p  children class %@&quot;</span>,<span class="hljs-keyword">self</span>.father.children,[<span class="hljs-keyword">self</span>.father.children <span class="hljs-keyword">class</span>]);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>控制台打印:</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs objc"><span class="hljs-number">2020</span><span class="hljs-number">-12</span><span class="hljs-number">-27</span> <span class="hljs-number">00</span>:<span class="hljs-number">11</span>:<span class="hljs-number">15.866438</span>+<span class="hljs-number">0800</span> Runtime-KVC[<span class="hljs-number">51719</span>:<span class="hljs-number">19314394</span>] befor ---- children = <span class="hljs-number">0x600003330360</span>  children <span class="hljs-keyword">class</span> __NSArrayM<br><span class="hljs-number">2020</span><span class="hljs-number">-12</span><span class="hljs-number">-27</span> <span class="hljs-number">00</span>:<span class="hljs-number">11</span>:<span class="hljs-number">15.866768</span>+<span class="hljs-number">0800</span> Runtime-KVC[<span class="hljs-number">51719</span>:<span class="hljs-number">19314394</span>] &#123;<br>    indexes = <span class="hljs-string">&quot;&lt;_NSCachedIndexSet: 0x600003d57c40&gt;[number of indexes: 1 (in 1 ranges), indexes: (1)]&quot;</span>;<br>    kind = <span class="hljs-number">2</span>;<br>    new =     (<br>        farmer<br>    );<br>&#125;<br><span class="hljs-number">2020</span><span class="hljs-number">-12</span><span class="hljs-number">-27</span> <span class="hljs-number">00</span>:<span class="hljs-number">11</span>:<span class="hljs-number">15.866870</span>+<span class="hljs-number">0800</span> Runtime-KVC[<span class="hljs-number">51719</span>:<span class="hljs-number">19314394</span>] after ---- children = <span class="hljs-number">0x600003330900</span>  children <span class="hljs-keyword">class</span> __NSArrayM<br><span class="hljs-number">2020</span><span class="hljs-number">-12</span><span class="hljs-number">-27</span> <span class="hljs-number">00</span>:<span class="hljs-number">11</span>:<span class="hljs-number">15.867033</span>+<span class="hljs-number">0800</span> Runtime-KVC[<span class="hljs-number">51719</span>:<span class="hljs-number">19314394</span>] &#123;<br>    indexes = <span class="hljs-string">&quot;&lt;_NSCachedIndexSet: 0x600003d57c60&gt;[number of indexes: 1 (in 1 ranges), indexes: (2)]&quot;</span>;<br>    kind = <span class="hljs-number">2</span>;<br>    new =     (<br>        air<br>    );<br>&#125;<br><span class="hljs-number">2020</span><span class="hljs-number">-12</span><span class="hljs-number">-27</span> <span class="hljs-number">00</span>:<span class="hljs-number">11</span>:<span class="hljs-number">15.867115</span>+<span class="hljs-number">0800</span> Runtime-KVC[<span class="hljs-number">51719</span>:<span class="hljs-number">19314394</span>] after ---- children = <span class="hljs-number">0x6000033590b0</span>  children <span class="hljs-keyword">class</span> __NSArrayM<br></code></pre></td></tr></table></figure>
<p>三次添加元素数组的地址分别为: <code>0x600003330360</code>,<code>0x600003330900</code>,<code>0x6000033590b0</code> 由此可见每次我们修改数组时都是重新创建一个数组然后调用setter方法重新赋值而非修改之前的数组。</p>
<p>如果我们每次增删改的时候都要重新创建数组，一旦我们的数组元素比较多时，效率肯定会受到一定的影响。所以这类方法一定要慎用。</p>
<p>但是如果我们必须要使用时，通过上面我们对查找顺序的了解我们需要在Father类中实现</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs objc">- (<span class="hljs-keyword">void</span>)removeObjectFromChildrenAtIndex:(<span class="hljs-built_in">NSUInteger</span>)index &#123;<br>    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;removeObjectFromChildrenAtIndex %@&quot;</span>,@(index));<br>    [<span class="hljs-keyword">self</span>.children removeObjectAtIndex:index];<br>&#125;<br><br>- (<span class="hljs-keyword">void</span>)insertObject:(<span class="hljs-built_in">NSString</span> *)object inChildrenAtIndex:(<span class="hljs-built_in">NSUInteger</span>)index &#123;<br>    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;insertObject: %@inChildrenAtIndex: %@&quot;</span>,object,@(index));<br>    [<span class="hljs-keyword">self</span>.children insertObject:object atIndex:index];<br>&#125;<br></code></pre></td></tr></table></figure>
<p>实现这两个方法后，就可以保证在第一步查找时就可以找到对应的方法，这样就不需要走setter方法，我们也可以实现KVO的监听。</p>
<p>我们可以通过下面代码验证:</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs objc">- (<span class="hljs-keyword">void</span>)mutableArrayValueForKey &#123;<br>    <span class="hljs-keyword">self</span>.father = [Father new];<br>    [<span class="hljs-keyword">self</span>.father.children addObject:<span class="hljs-string">@&quot;son1&quot;</span>];<br>    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;befor ---- children = %p  children class %@&quot;</span>,<span class="hljs-keyword">self</span>.father.children,[<span class="hljs-keyword">self</span>.father.children <span class="hljs-keyword">class</span>]);<br>    [[<span class="hljs-keyword">self</span>.father mutableArrayValueForKey:<span class="hljs-string">@&quot;children&quot;</span>] addObject:<span class="hljs-string">@&quot;farmer&quot;</span>];<br>    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;after ---- children = %p  children class %@&quot;</span>,<span class="hljs-keyword">self</span>.father.children,[<span class="hljs-keyword">self</span>.father.children <span class="hljs-keyword">class</span>]);<br>    [[<span class="hljs-keyword">self</span>.father mutableArrayValueForKey:<span class="hljs-string">@&quot;children&quot;</span>] addObject:<span class="hljs-string">@&quot;air&quot;</span>];<br>    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;after ---- children = %p  children class %@&quot;</span>,<span class="hljs-keyword">self</span>.father.children,[<span class="hljs-keyword">self</span>.father.children <span class="hljs-keyword">class</span>]);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>控制台输出:</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs objc"><span class="hljs-number">2020</span><span class="hljs-number">-12</span><span class="hljs-number">-27</span> <span class="hljs-number">00</span>:<span class="hljs-number">30</span>:<span class="hljs-number">06.297870</span>+<span class="hljs-number">0800</span> Runtime-KVC[<span class="hljs-number">51979</span>:<span class="hljs-number">19331763</span>] befor ---- children = <span class="hljs-number">0x6000008b9a40</span>  children <span class="hljs-keyword">class</span> __NSArrayM<br><span class="hljs-number">2020</span><span class="hljs-number">-12</span><span class="hljs-number">-27</span> <span class="hljs-number">00</span>:<span class="hljs-number">30</span>:<span class="hljs-number">06.298069</span>+<span class="hljs-number">0800</span> Runtime-KVC[<span class="hljs-number">51979</span>:<span class="hljs-number">19331763</span>] insertObject: farmerinChildrenAtIndex: <span class="hljs-number">1</span><br><span class="hljs-number">2020</span><span class="hljs-number">-12</span><span class="hljs-number">-27</span> <span class="hljs-number">00</span>:<span class="hljs-number">30</span>:<span class="hljs-number">06.298360</span>+<span class="hljs-number">0800</span> Runtime-KVC[<span class="hljs-number">51979</span>:<span class="hljs-number">19331763</span>] &#123;<br>    indexes = <span class="hljs-string">&quot;&lt;_NSCachedIndexSet: 0x6000006d02e0&gt;[number of indexes: 1 (in 1 ranges), indexes: (1)]&quot;</span>;<br>    kind = <span class="hljs-number">2</span>;<br>    new =     (<br>        farmer<br>    );<br>&#125;<br><span class="hljs-number">2020</span><span class="hljs-number">-12</span><span class="hljs-number">-27</span> <span class="hljs-number">00</span>:<span class="hljs-number">30</span>:<span class="hljs-number">06.298480</span>+<span class="hljs-number">0800</span> Runtime-KVC[<span class="hljs-number">51979</span>:<span class="hljs-number">19331763</span>] after ---- children = <span class="hljs-number">0x6000008b9a40</span>  children <span class="hljs-keyword">class</span> __NSArrayM<br><span class="hljs-number">2020</span><span class="hljs-number">-12</span><span class="hljs-number">-27</span> <span class="hljs-number">00</span>:<span class="hljs-number">30</span>:<span class="hljs-number">06.298595</span>+<span class="hljs-number">0800</span> Runtime-KVC[<span class="hljs-number">51979</span>:<span class="hljs-number">19331763</span>] insertObject: airinChildrenAtIndex: <span class="hljs-number">2</span><br><span class="hljs-number">2020</span><span class="hljs-number">-12</span><span class="hljs-number">-27</span> <span class="hljs-number">00</span>:<span class="hljs-number">30</span>:<span class="hljs-number">06.298754</span>+<span class="hljs-number">0800</span> Runtime-KVC[<span class="hljs-number">51979</span>:<span class="hljs-number">19331763</span>] &#123;<br>    indexes = <span class="hljs-string">&quot;&lt;_NSCachedIndexSet: 0x6000006d0300&gt;[number of indexes: 1 (in 1 ranges), indexes: (2)]&quot;</span>;<br>    kind = <span class="hljs-number">2</span>;<br>    new =     (<br>        air<br>    );<br>&#125;<br><span class="hljs-number">2020</span><span class="hljs-number">-12</span><span class="hljs-number">-27</span> <span class="hljs-number">00</span>:<span class="hljs-number">30</span>:<span class="hljs-number">06.298854</span>+<span class="hljs-number">0800</span> Runtime-KVC[<span class="hljs-number">51979</span>:<span class="hljs-number">19331763</span>] after ---- children = <span class="hljs-number">0x6000008b9a40</span>  children <span class="hljs-keyword">class</span> __NSArrayM<br></code></pre></td></tr></table></figure>
<p>从上面的log中我们可以看到在直接调用addObject和使用mutableArrayValueForKey方法获取到数组后在进行添加操作数组对象并没有发生改变均为<code>0x6000008b9a40</code>。</p>
<p>但是我们同时也发现了一个问题，在没有调用setter方法时我们也可以通过KVO监听到了数据的变化？</p>
<p>因此，我们猜想必定是子类也重写了对应的方法，然后在方法的前后调用了willChange和didChange方法，因此我们先在Father类中实现willChange和didChange的集合方法</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs objc">- (<span class="hljs-keyword">void</span>)willChange:(<span class="hljs-built_in">NSKeyValueChange</span>)changeKind valuesAtIndexes:(<span class="hljs-built_in">NSIndexSet</span> *)indexes forKey:(<span class="hljs-built_in">NSString</span> *)key &#123;<br>    [<span class="hljs-keyword">super</span> willChange:changeKind valuesAtIndexes:indexes forKey:key];<br>    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;willChange: valuesAtIndexes: forKey:%@&quot;</span>,key);<br>&#125;<br><br>- (<span class="hljs-keyword">void</span>)didChange:(<span class="hljs-built_in">NSKeyValueChange</span>)changeKind valuesAtIndexes:(<span class="hljs-built_in">NSIndexSet</span> *)indexes forKey:(<span class="hljs-built_in">NSString</span> *)key &#123;<br>    [<span class="hljs-keyword">super</span> didChange:changeKind valuesAtIndexes:indexes forKey:key];<br>    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;didChange: valuesAtIndexes: forKey:%@&quot;</span>,key);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>接下来我们在进行测试:</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs objc">- (<span class="hljs-keyword">void</span>)mutableArrayValueForKey &#123;<br>    <span class="hljs-keyword">self</span>.father = [Father new];<br>    [[<span class="hljs-keyword">self</span>.father mutableArrayValueForKey:<span class="hljs-string">@&quot;children&quot;</span>] addObject:<span class="hljs-string">@&quot;farmer&quot;</span>];<br>&#125;<br></code></pre></td></tr></table></figure>
<p>控制台输出:</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs objc"><span class="hljs-number">2020</span><span class="hljs-number">-12</span><span class="hljs-number">-27</span> <span class="hljs-number">12</span>:<span class="hljs-number">26</span>:<span class="hljs-number">07.867838</span>+<span class="hljs-number">0800</span> Runtime-KVC[<span class="hljs-number">56961</span>:<span class="hljs-number">19600302</span>] willChange: valuesAtIndexes: forKey:children<br><span class="hljs-number">2020</span><span class="hljs-number">-12</span><span class="hljs-number">-27</span> <span class="hljs-number">12</span>:<span class="hljs-number">26</span>:<span class="hljs-number">07.868068</span>+<span class="hljs-number">0800</span> Runtime-KVC[<span class="hljs-number">56961</span>:<span class="hljs-number">19600302</span>] insertObject: farmerinChildrenAtIndex: <span class="hljs-number">1</span><br><span class="hljs-number">2020</span><span class="hljs-number">-12</span><span class="hljs-number">-27</span> <span class="hljs-number">12</span>:<span class="hljs-number">26</span>:<span class="hljs-number">07.868480</span>+<span class="hljs-number">0800</span> Runtime-KVC[<span class="hljs-number">56961</span>:<span class="hljs-number">19600302</span>] &#123;<br>    indexes = <span class="hljs-string">&quot;&lt;_NSCachedIndexSet: 0x600001a17b80&gt;[number of indexes: 1 (in 1 ranges), indexes: (1)]&quot;</span>;<br>    kind = <span class="hljs-number">2</span>;<br>    new =     (<br>        farmer<br>    );<br>&#125;<br><span class="hljs-number">2020</span><span class="hljs-number">-12</span><span class="hljs-number">-27</span> <span class="hljs-number">12</span>:<span class="hljs-number">26</span>:<span class="hljs-number">07.868618</span>+<span class="hljs-number">0800</span> Runtime-KVC[<span class="hljs-number">56961</span>:<span class="hljs-number">19600302</span>] didChange: valuesAtIndexes: forKey:children<br></code></pre></td></tr></table></figure>

<p>从日志我们看出在修改方法`insertObject:inChildrenAtIndex:的前后willChange: valuesAtIndexes: forKey:children和didChange: valuesAtIndexes: forKey:children方法被调用我们通过断点看下</p>
<p><img src="https://tva1.sinaimg.cn/large/0081Kckwly1gm2azjmsh4j32600iaqtg.jpg"></p>
<p>从上图我们可以看出willChange: valuesAtIndexes: forKey:children方法是在NSKeyValueNotifyingMutableArray._mutableArray 调用addObject时被调用。<br>很明显NSKeyValueNotifyingMutableArray就是KVO动态创建的子类，即[self.father mutableArrayValueForKey:@”children”]返回的集合代理类,这个类也实现了removeObjectFromChildrenAtIndex:和insertObject:inChildrenAtIndex:两个方法，并在方法调用前后分别调用了KVO的方法通知给外部。</p>
<h3 id="KVC-应用"><a href="#KVC-应用" class="headerlink" title="KVC 应用"></a>KVC 应用</h3><p>除了我们常用的获取对象的某些属性值以外，还有一些高级用法比如：</p>
<h4 id="常规操作符"><a href="#常规操作符" class="headerlink" title="常规操作符"></a>常规操作符</h4><ul>
<li>@sum：值的总和</li>
<li>@avg：平均值</li>
<li>@count：总个数</li>
<li>@max：最大值</li>
<li>@min：最小值</li>
</ul>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs objc">- (<span class="hljs-keyword">void</span>)advanceKVCMethod &#123;<br>    Person *p1 = [Person new];<br>    p1.age = <span class="hljs-number">10</span>;<br><br>    Person *p2 = [Person new];<br>    p2.age = <span class="hljs-number">20</span>;<br><br>    Person *p3 = [Person new];<br>    p3.age = <span class="hljs-number">30</span>;<br><br>    Person *p4 = [Person new];<br>    p4.age = <span class="hljs-number">40</span>;<br><br>    <span class="hljs-built_in">NSArray</span> *pArray = @[p1,p2,p3,p4];<br><br>    <span class="hljs-built_in">NSNumber</span> *ageSum = [pArray valueForKeyPath:<span class="hljs-string">@&quot;@sum.age&quot;</span>];<br>    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;年龄的总和为 %@&quot;</span>,ageSum);<br><br>    <span class="hljs-built_in">NSNumber</span> *average = [pArray valueForKeyPath:<span class="hljs-string">@&quot;@avg.age&quot;</span>];<br>    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;年龄的平均值为 %@&quot;</span>,average);<br><br>    <span class="hljs-built_in">NSNumber</span> *count = [pArray valueForKeyPath:<span class="hljs-string">@&quot;@count&quot;</span>];<br>    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;年龄的个数 %@&quot;</span>,count);<br><br>    <span class="hljs-built_in">NSNumber</span> *max = [pArray valueForKeyPath:<span class="hljs-string">@&quot;@max.age&quot;</span>];<br>    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;年龄最大的为 %@&quot;</span>,max);<br><br>    <span class="hljs-built_in">NSNumber</span> *min = [pArray valueForKeyPath:<span class="hljs-string">@&quot;@min.age&quot;</span>];<br>    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;年龄最小的为 %@&quot;</span>,min);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>打印结果:</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs objc"><span class="hljs-number">2020</span><span class="hljs-number">-12</span><span class="hljs-number">-27</span> <span class="hljs-number">12</span>:<span class="hljs-number">58</span>:<span class="hljs-number">50.510127</span>+<span class="hljs-number">0800</span> Runtime-KVC[<span class="hljs-number">57474</span>:<span class="hljs-number">19627879</span>] 年龄的总和为 <span class="hljs-number">100</span><br><span class="hljs-number">2020</span><span class="hljs-number">-12</span><span class="hljs-number">-27</span> <span class="hljs-number">12</span>:<span class="hljs-number">58</span>:<span class="hljs-number">50.510338</span>+<span class="hljs-number">0800</span> Runtime-KVC[<span class="hljs-number">57474</span>:<span class="hljs-number">19627879</span>] 年龄的平均值为 <span class="hljs-number">25</span><br><span class="hljs-number">2020</span><span class="hljs-number">-12</span><span class="hljs-number">-27</span> <span class="hljs-number">12</span>:<span class="hljs-number">58</span>:<span class="hljs-number">50.510549</span>+<span class="hljs-number">0800</span> Runtime-KVC[<span class="hljs-number">57474</span>:<span class="hljs-number">19627879</span>] 年龄的个数 <span class="hljs-number">4</span><br><span class="hljs-number">2020</span><span class="hljs-number">-12</span><span class="hljs-number">-27</span> <span class="hljs-number">12</span>:<span class="hljs-number">58</span>:<span class="hljs-number">50.510718</span>+<span class="hljs-number">0800</span> Runtime-KVC[<span class="hljs-number">57474</span>:<span class="hljs-number">19627879</span>] 年龄最大的为 <span class="hljs-number">40</span><br><span class="hljs-number">2020</span><span class="hljs-number">-12</span><span class="hljs-number">-27</span> <span class="hljs-number">12</span>:<span class="hljs-number">58</span>:<span class="hljs-number">50.510872</span>+<span class="hljs-number">0800</span> Runtime-KVC[<span class="hljs-number">57474</span>:<span class="hljs-number">19627879</span>] 年龄最小的为 <span class="hljs-number">10</span><br></code></pre></td></tr></table></figure>

<h4 id="集合去重"><a href="#集合去重" class="headerlink" title="集合去重"></a>集合去重</h4><ul>
<li>@distinctUnionOfObjects：元素唯一，会进行去重</li>
<li>@unionOfObjects：不会去重</li>
</ul>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs objc">- (<span class="hljs-keyword">void</span>)advanceKVCDistinctMethod &#123;<br>    Person *p1 = [Person new];<br>    p1.age = <span class="hljs-number">10</span>;<br><br>    Person *p2 = [Person new];<br>    p2.age = <span class="hljs-number">20</span>;<br><br>    Person *p3 = [Person new];<br>    p3.age = <span class="hljs-number">20</span>;<br><br>    Person *p4 = [Person new];<br>    p4.age = <span class="hljs-number">30</span>;<br><br>    <span class="hljs-built_in">NSArray</span> *pArray = @[p1,p2,p3,p4];<br><br>    <span class="hljs-built_in">NSArray</span> *distinctUnionOfObjectsArray=[pArray valueForKeyPath:<span class="hljs-string">@&quot;@distinctUnionOfObjects.age&quot;</span>];<br>    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;distinctUnionOfObjects:%@&quot;</span>,distinctUnionOfObjectsArray);<br><br>    <span class="hljs-built_in">NSArray</span> *unionOfObjectsArray=[pArray valueForKeyPath:<span class="hljs-string">@&quot;@unionOfObjects.age&quot;</span>];<br>    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;unionOfObjects:%@&quot;</span>,unionOfObjectsArray);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>输出结果：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs objc"><span class="hljs-number">2020</span><span class="hljs-number">-12</span><span class="hljs-number">-27</span> <span class="hljs-number">13</span>:<span class="hljs-number">16</span>:<span class="hljs-number">42.349274</span>+<span class="hljs-number">0800</span> Runtime-KVC[<span class="hljs-number">57721</span>:<span class="hljs-number">19644904</span>] distinctUnionOfObjects:(<br>    <span class="hljs-number">10</span>,<br>    <span class="hljs-number">20</span>,<br>    <span class="hljs-number">30</span><br>)<br><span class="hljs-number">2020</span><span class="hljs-number">-12</span><span class="hljs-number">-27</span> <span class="hljs-number">13</span>:<span class="hljs-number">16</span>:<span class="hljs-number">42.349493</span>+<span class="hljs-number">0800</span> Runtime-KVC[<span class="hljs-number">57721</span>:<span class="hljs-number">19644904</span>] unionOfObjects:(<br>    <span class="hljs-number">10</span>,<br>    <span class="hljs-number">20</span>,<br>    <span class="hljs-number">20</span>,<br>    <span class="hljs-number">30</span><br>)<br></code></pre></td></tr></table></figure>


<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>这篇文章我们主要从setValue:forKey:和valueForyKey:以及集合类型的mutableArrayValueForKey:去讲解KVC的实现和查找策略，让我们对KVC的实现有了一个比较清楚的认知，最后我们还介绍了几种KVC的高级用法，在某些场景也可以减少我们遍历的依赖。</p>
<h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><p><a target="_blank" rel="noopener" href="http://blog.xtxiete.com/2018/12/11/KVOMutableArray%E7%9A%84%E5%88%86%E6%9E%90%E5%92%8C%E7%90%86%E8%A7%A3/">KVOMutableArray的分析和理解</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.chenyalun.com/2019/05/05/%E8%AF%A6%E8%A7%A3Key-Value%20Coding%E6%BA%90%E7%A0%81/">详解Key-Value Coding源码</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/LeeWongSnail/Blog_Demo/tree/master/Runtime-KVC">本文demo</a></p>

    </div>
     
    <div class="post-footer__meta"><p>更新于 2020-12-27</p></div> 
    <div class="post-meta__cats"><a href="/categories/Runtime/" class="post-cats__link button">Runtime</a><a href="/tags/Runtime-KVC/" class="post-tags__link button"># Runtime KVC</a></div> 
</article>


    <div class="nav">
        <div class="nav__prev">
            
        </div>
        <div class="nav__next">
            
                <a href="/2020/12/05/runtime-kvo/" class="nav__link">
                    <div>
                        <div class="nav__label">
                            Next Post
                        </div>
                        <div class="nav__title">
                            Runtime之KVO
                        </div>
                    </div>
                    <div>
                        <svg viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" width="24" height="24"><path d="M434.944 790.624l-45.248-45.248L623.04 512l-233.376-233.376 45.248-45.248L713.568 512z" fill="#808080"></path></svg>
                    </div>
                </a>
            
        </div>
    </div>





</main>

            <footer class="footer">
    


    
    
    
        <span id="busuanzi_container_site_uv" hidden>
            <span></span>
            <span id="busuanzi_value_site_uv"></span>
            <span>Viewers</span>
            
                <span>&amp;nbsp;&amp;nbsp;&amp;nbsp;|</span>
            
        </span>
    
    
        <span id="busuanzi_container_site_pv" hidden>
            <span></span>
            <span id="busuanzi_value_site_pv"></span>
            <span>Views</span>
            
        </span>
    
 
 

 
    
        
        <p class="footer-copyright">
            Copyright © 2015&nbsp;-&nbsp;2020 <a href="/">LeeWong</a>
        </p>
    
    
    <p>Powered by <a href="https://hexo.io" target="_blank">Hexo</a> | Theme - <a href="https://github.com/ChrAlpha/hexo-theme-cards" target="_blank">Cards</a></p>
</footer>

        </div>
         

 
    <script>
        window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
        ga('create', '4NmLVard-jFEKaV6857m9tKb41Tpo4FiKj8L1TJg7lU', 'auto');
        ga('send', 'pageview');
    </script>
    <script async src="https://www.google-analytics.com/analytics.js"></script>
 

 

 
    <script>
        var _hmt = _hmt || [];
        (function() {
            var hm = document.createElement('script');
            hm.src = 'https://hm.baidu.com/hm.js?DR81zbdrQ3';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(hm, s);
        })();
    </script>
 

  



 


    
 


    
<script src="https://cdn.jsdelivr.net/npm/jquery@3.4.1/dist/jquery.min.js"></script>

    
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.4.1/dist/jquery.fancybox.min.css">

    
<script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.4.1/dist/jquery.fancybox.min.js"></script>

    <script>
        let lazyloadT = Boolean('false'),
            auto_fancybox = Boolean('false')
        if (auto_fancybox) {
            $(".post__content").find('img').each(function () {
                var element = document.createElement("a");
                $(element).attr("data-fancybox", "gallery");
                $(element).attr("href", $(this).attr("src"));
                if (lazyloadT) {
                    $(element).attr("href", $(this).attr("data-srcset"));
                }
                $(this).wrap(element);
            });
        } else {
            $(".post__content").find("fancybox").find('img').each(function () {
                var element = document.createElement("a");
                $(element).attr("data-fancybox", "gallery");
                $(element).attr("href", $(this).attr("src"));
                if (lazyloadT) {
                    $(element).attr("href", $(this).attr("data-srcset"));
                }
                $(this).wrap(element);
            });
        }
    </script>
 

 

 

 




    </body>
</html>
