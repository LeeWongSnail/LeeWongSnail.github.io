<!DOCTYPE html>
<html lang="zh-CN">
    <head>
    <meta charset="utf-8">

    

    <!-- 渲染优化 -->
    <meta name="renderer" content="webkit">
    <meta name="force-rendering" content="webkit">
    <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1">
    <meta name="HandheldFriendly" content="True" >
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

    <!--icon-->

    
        <link rel="shortcut icon" href="https://tva1.sinaimg.cn/large/0081Kckwly1glcsnw2jatj303k03k748.jpg">
    
    
    
    
    


    <!-- meta -->


<title>Runtime之方法交换 | LeeWong</title>


    <meta name="keywords" content="Runtime ExchangeImplementations, iOS">




    <!-- OpenGraph -->
 
    <meta name="description" content="简介前面几篇文章我们介绍了Runtime中NSObject的数据结构，下面我们来介绍下Runtime在平时开发过程中的常用方法以及实现原理。">
<meta property="og:type" content="article">
<meta property="og:title" content="Runtime之方法交换">
<meta property="og:url" content="https://www.leewong.cn/2020/10/25/runtime-methodswizzle/index.html">
<meta property="og:site_name" content="LeeWong">
<meta property="og:description" content="简介前面几篇文章我们介绍了Runtime中NSObject的数据结构，下面我们来介绍下Runtime在平时开发过程中的常用方法以及实现原理。">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://tva1.sinaimg.cn/large/0081Kckwly1glcudcqxexj31400mcabn.jpg">
<meta property="article:published_time" content="2020-10-25T08:47:55.000Z">
<meta property="article:modified_time" content="2020-12-05T04:01:40.505Z">
<meta property="article:author" content="LeeWong">
<meta property="article:tag" content="Runtime ExchangeImplementations">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://tva1.sinaimg.cn/large/0081Kckwly1glcudcqxexj31400mcabn.jpg">


    
<link rel="stylesheet" href="/css/style/main.css">
 


    
<link rel="stylesheet" href="/css/style/dark.css">

    
<script src="/js/darkmode.js"></script>



    
    
    
        <link rel="stylesheet" id="hl-default-theme" href="https://cdn.jsdelivr.net/npm/highlight.js@10.1.2/styles/default.min.css" media="none" onload="if(getComputedStyle(document.documentElement).getPropertyValue('--color-mode').indexOf('dark')===-1)this.media='all'">
        
            <link rel="stylesheet" id="hl-dark-theme" href="https://cdn.jsdelivr.net/npm/highlight.js@10.1.2/styles/dark.min.css" media="none" onload="if(getComputedStyle(document.documentElement).getPropertyValue('--color-mode').indexOf('dark')!==-1)this.media='all'">
        
    

    

     
    <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
 

    <!-- custom head -->

    
        <meta name="google-site-verification" content="4NmLVard-jFEKaV6857m9tKb41Tpo4FiKj8L1TJg7lU" /> 
    

<meta name="generator" content="Hexo 5.1.1"></head>

    <body>
        <div id="app">
            <header class="header">
    <div class="header__left">
        <a href="/" class="button">
            <span class="logo__text">LeeWong</span>
        </a>
    </div>
    <div class="header__right">
        
            <div class="navbar__menus">
                
                    <a href="/" class="navbar-menu button">首页</a>
                
                    <a href="/tags/" class="navbar-menu button">标签</a>
                
                    <a href="/archives/" class="navbar-menu button">归档</a>
                
                    <a href="/about/" class="navbar-menu button">关于我</a>
                
            </div>
        
        
        

        
        
    <a href="javaScript:void(0);" id="btn-toggle-dark">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg>
    </a>


         
    <a href="#" class="button" id="b2t" aria-label="回到顶部" title="回到顶部">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1024 1024" width="32" height="32">
            <path d="M233.376 722.752L278.624 768 512 534.624 745.376 768l45.248-45.248L512 444.128zM192 352h640V288H192z" fill="currentColor"></path>
        </svg>
    </a>


        
            <a class="dropdown-icon button" id="btn-dropdown" tabindex="0"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" width='24' height='24' fill="none" stroke="currentColor" stroke-width="0.7" stroke-linecap="round" stroke-linejoin="round"><path fill="currentColor" d="M3.314,4.8h13.372c0.41,0,0.743-0.333,0.743-0.743c0-0.41-0.333-0.743-0.743-0.743H3.314c-0.41,0-0.743,0.333-0.743,0.743C2.571,4.467,2.904,4.8,3.314,4.8z M16.686,15.2H3.314c-0.41,0-0.743,0.333-0.743,0.743s0.333,0.743,0.743,0.743h13.372c0.41,0,0.743-0.333,0.743-0.743S17.096,15.2,16.686,15.2z M16.686,9.257H3.314c-0.41,0-0.743,0.333-0.743,0.743s0.333,0.743,0.743,0.743h13.372c0.41,0,0.743-0.333,0.743-0.743S17.096,9.257,16.686,9.257z"></path></svg></a>
            <div class="dropdown-menus" id="dropdown-menus">
                
                    <a href="/" class="dropdown-menu button">首页</a>
                
                    <a href="/tags/" class="dropdown-menu button">标签</a>
                
                    <a href="/archives/" class="dropdown-menu button">归档</a>
                
                    <a href="/about/" class="dropdown-menu button">关于我</a>
                
            </div>
        
    </div>
</header>


            <main class="main">
    

<div class="post-title">
    <h1 class="post-title__text">
        Runtime之方法交换
    </h1>
    <div class="post-title__meta">
        <a href="/archives/2020/10/" class="post-meta__date button">2020-10-25</a>
        
    <span class="separate-dot"></span><a href="/categories/Runtime/" class="button">Runtime</a>

 
        
    
     
    <span id="busuanzi_container_page_pv" hidden>
        <span class="separate-dot"></span>
        <span></span>
        <span id="busuanzi_value_page_pv"></span>
        <span>Views</span>
    </span>



 

 
    </div>
</div>


    <aside class="post-side">
        <div class="post-side__toc">
            <ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AE%80%E4%BB%8B"><span class="toc-number">1.</span> <span class="toc-text">简介</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%96%B9%E6%B3%95%E4%BA%A4%E6%8D%A2"><span class="toc-number">2.</span> <span class="toc-text">方法交换</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#class-getInstanceMethod"><span class="toc-number">2.1.</span> <span class="toc-text">class_getInstanceMethod</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#getMethod-nolock"><span class="toc-number">2.1.1.</span> <span class="toc-text">getMethod_nolock</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#getMethodNoSuper-nolock"><span class="toc-number">2.1.2.</span> <span class="toc-text">getMethodNoSuper_nolock</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#search-method-list"><span class="toc-number">2.1.3.</span> <span class="toc-text">search_method_list</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#class-addMethod"><span class="toc-number">2.2.</span> <span class="toc-text">class_addMethod</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#class-replaceMethod"><span class="toc-number">2.3.</span> <span class="toc-text">class_replaceMethod</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#method-exchangeImplementations"><span class="toc-number">2.4.</span> <span class="toc-text">method_exchangeImplementations</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E9%97%AE%E9%A2%98%E4%B8%80%EF%BC%9A"><span class="toc-number">2.4.0.1.</span> <span class="toc-text">问题一：</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E9%97%AE%E9%A2%98%E4%BA%8C%EF%BC%9A"><span class="toc-number">2.4.0.2.</span> <span class="toc-text">问题二：</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E9%97%AE%E9%A2%98%E4%B8%89%EF%BC%9A"><span class="toc-number">2.4.0.3.</span> <span class="toc-text">问题三：</span></a></li></ol></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%B1%BB%E6%96%B9%E6%B3%95%E7%9A%84%E6%96%B9%E6%B3%95%E4%BA%A4%E6%8D%A2"><span class="toc-number">2.5.</span> <span class="toc-text">类方法的方法交换</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#class-getClassMethod"><span class="toc-number">2.5.1.</span> <span class="toc-text">class_getClassMethod</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#object-getClass"><span class="toc-number">2.5.2.</span> <span class="toc-text">object_getClass</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Demo"><span class="toc-number">3.</span> <span class="toc-text">Demo</span></a></li></ol>
        </div>
    </aside>
    <a class="btn-toc button" id="btn-toc" tabindex="0">
        <svg viewBox="0 0 1024 1024" width="32" height="32" xmlns="http://www.w3.org/2000/svg">
            <path d="M128 256h64V192H128zM320 256h576V192H320zM128 544h64v-64H128zM320 544h576v-64H320zM128 832h64v-64H128zM320 832h576v-64H320z" fill="currentColor"></path>
        </svg>
    </a>
    <div class="toc-menus" id="toc-menus">
        <div class="toc-title">文章目录</div>
        <ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AE%80%E4%BB%8B"><span class="toc-number">1.</span> <span class="toc-text">简介</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%96%B9%E6%B3%95%E4%BA%A4%E6%8D%A2"><span class="toc-number">2.</span> <span class="toc-text">方法交换</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#class-getInstanceMethod"><span class="toc-number">2.1.</span> <span class="toc-text">class_getInstanceMethod</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#getMethod-nolock"><span class="toc-number">2.1.1.</span> <span class="toc-text">getMethod_nolock</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#getMethodNoSuper-nolock"><span class="toc-number">2.1.2.</span> <span class="toc-text">getMethodNoSuper_nolock</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#search-method-list"><span class="toc-number">2.1.3.</span> <span class="toc-text">search_method_list</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#class-addMethod"><span class="toc-number">2.2.</span> <span class="toc-text">class_addMethod</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#class-replaceMethod"><span class="toc-number">2.3.</span> <span class="toc-text">class_replaceMethod</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#method-exchangeImplementations"><span class="toc-number">2.4.</span> <span class="toc-text">method_exchangeImplementations</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E9%97%AE%E9%A2%98%E4%B8%80%EF%BC%9A"><span class="toc-number">2.4.0.1.</span> <span class="toc-text">问题一：</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E9%97%AE%E9%A2%98%E4%BA%8C%EF%BC%9A"><span class="toc-number">2.4.0.2.</span> <span class="toc-text">问题二：</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E9%97%AE%E9%A2%98%E4%B8%89%EF%BC%9A"><span class="toc-number">2.4.0.3.</span> <span class="toc-text">问题三：</span></a></li></ol></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%B1%BB%E6%96%B9%E6%B3%95%E7%9A%84%E6%96%B9%E6%B3%95%E4%BA%A4%E6%8D%A2"><span class="toc-number">2.5.</span> <span class="toc-text">类方法的方法交换</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#class-getClassMethod"><span class="toc-number">2.5.1.</span> <span class="toc-text">class_getClassMethod</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#object-getClass"><span class="toc-number">2.5.2.</span> <span class="toc-text">object_getClass</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Demo"><span class="toc-number">3.</span> <span class="toc-text">Demo</span></a></li></ol>
    </div>


<article class="post content-card">
    <div class="post__header">
    
        <div class="post-thumbnail" style="background-image: url('https://tva1.sinaimg.cn/large/0081Kckwly1glcudcqxexj31400mcabn.jpg');"></div>
    
</div>
    <div class="post__content">
        <h3 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h3><p>前面几篇文章我们介绍了Runtime中NSObject的数据结构，下面我们来介绍下Runtime在平时开发过程中的常用方法以及实现原理。</p>
<a id="more"></a>

<h3 id="方法交换"><a href="#方法交换" class="headerlink" title="方法交换"></a>方法交换</h3><p>方法交换可以说是我们在开发中比较常用的方法，尤其是在一些需要埋点或者统计的位置，我们可以通过Hook系统的某些方法，通过在这些方法中添加自己代码的方式实现在不入侵业务的情况下实现功能。</p>
<p>首先我们来看下方法交换的实现，下面这段代码使我们在网上随便找了一份方法交换的代码实现：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs objc">+ (<span class="hljs-built_in">BOOL</span>)swizzleMethod:(Class)<span class="hljs-keyword">class</span> orgSel:(SEL)origSel swizzSel:(SEL)altSel &#123;<br>    Method origMethod = class_getInstanceMethod(<span class="hljs-keyword">class</span>, origSel);<br>    Method altMethod = class_getInstanceMethod(<span class="hljs-keyword">class</span>, altSel);<br>    <span class="hljs-keyword">if</span> (!origMethod || !altMethod) &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">NO</span>;<br>    &#125;<br>    <span class="hljs-built_in">BOOL</span> didAddMethod = class_addMethod(<span class="hljs-keyword">class</span>,origSel,<br>                                        method_getImplementation(altMethod),<br>                                        method_getTypeEncoding(altMethod));<br>    <br>    <span class="hljs-keyword">if</span> (didAddMethod) &#123;<br>        class_replaceMethod(<span class="hljs-keyword">class</span>,altSel,<br>                            method_getImplementation(origMethod),<br>                            method_getTypeEncoding(origMethod));<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        method_exchangeImplementations(origMethod, altMethod);<br>    &#125;<br>    <br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">YES</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>这个方法是交换class类中<code>origSel</code>方法和<code>swizzSel</code>方法。我们先来分析这个方法的实现步骤：</p>
<ul>
<li><code>swizzleMethod</code>方法的三个参数分别为class交换方法的类 <code>origSel</code> 原方法 <code>altSel</code>要替换的方法</li>
<li><code>class_getInstanceMethod</code>通过<code>runtime</code>的这个方法获取方法Method结构体</li>
<li>给class添加<code>origSel</code>方法 方法的实现是<code>altSel</code>的实现</li>
<li>如果第三步添加成功 则替换<code>class</code>中<code>altSel</code>方法实现为<code>origSel</code></li>
<li>如果第三步添加失败 则交换<code>origMethod</code>和<code>altMethod</code>方法的实现</li>
</ul>
<p>下面我们先针对上面的实现提出几个自己的问题，然后带着这些问题去研究为什么需要这么实现，这么实现是否有其他的问题。</p>
<p>问题一：<code>class_getInstanceMethod</code>到底是从哪里获取方法实现？如果是父类方法可以获取到吗？<br>问题二：交换方法之前为何要调用<code>class_addMethod</code>方法先去添加方法？<br>问题三：为何根据添加方法<code>class_addMethod</code>的返回值去判断下一步的操作？<br>问题四：<code>method_exchangeImplementations</code>和<code>class_replaceMethod</code>的区别是什么？<br>问题五：大多数方法都是交换一个类中的两个方法，是否可以交换两个不同类的方法呢？方法名相同可以交换吗？</p>
<p>下面我们带着这些问题来看方法交换的具体实现：</p>
<h4 id="class-getInstanceMethod"><a href="#class-getInstanceMethod" class="headerlink" title="class_getInstanceMethod"></a>class_getInstanceMethod</h4><p>我们先来看下方法的实现：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs objc"><span class="hljs-comment">// 获取cls类中对象方法sel的实现</span><br>Method class_getInstanceMethod(Class cls, SEL sel)<br>&#123;<br>    <span class="hljs-keyword">if</span> (!cls  ||  !sel) <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>;<br>    <span class="hljs-comment">// Search method lists, try method resolver, etc.</span><br>    <span class="hljs-comment">// 搜索方法列表 这个方法是有返回值的 但是在这里并没有用到返回值</span><br>    lookUpImpOrNil(cls, sel, <span class="hljs-literal">nil</span>, <br>                   <span class="hljs-literal">NO</span><span class="hljs-comment">/*initialize*/</span>, <span class="hljs-literal">NO</span><span class="hljs-comment">/*cache*/</span>, <span class="hljs-literal">YES</span><span class="hljs-comment">/*resolver*/</span>);<br>    <span class="hljs-comment">// 递归获取cls的sel方法</span><br>    <span class="hljs-keyword">return</span> _class_getMethod(cls, sel);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>从这个方法的实现中我们看到在正式调用<code>_class_getMethod</code>方法获取实例方法前，还调用了lookUpImpOrNil方法，这个方法又是做什么的呢？关于这个问题，我们在后面消息转发模块会进一步介绍，这里暂时略过。</p>
<p>我们来看下递归查找方法的实现：</p>
<h5 id="getMethod-nolock"><a href="#getMethod-nolock" class="headerlink" title="getMethod_nolock"></a>getMethod_nolock</h5><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs objc"><span class="hljs-comment">// 无锁情况下过去cls类的实例方法sel</span><br><span class="hljs-keyword">static</span> method_t *<br>getMethod_nolock(Class cls, SEL sel)<br>&#123;<br>    method_t *m = <span class="hljs-literal">nil</span>;<br><br>    runtimeLock.assertLocked();<br>    <span class="hljs-comment">// 类是否被实例化 每个被实例化的类实际上是有一个标志位</span><br>    assert(cls-&gt;isRealized());<br>    <span class="hljs-comment">// 这里通过while循环的方式不断的查找当前类-&gt;父类-&gt;...的方法查找这个方法 直到找到方法或者是找到cls-&gt;superclass=nil</span><br>    <span class="hljs-keyword">while</span> (cls  &amp;&amp;  ((m = getMethodNoSuper_nolock(cls, sel))) == <span class="hljs-literal">nil</span>) &#123;<br>        cls = cls-&gt;superclass;<br>    &#125;<br><br>    <span class="hljs-keyword">return</span> m;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>看到这个实现后，我们的第一个问题的答案就显而易见了。<code>class_getInstanceMethod</code>方法在获取实例方法时会递归遍历所有的父类来查找<code>sel</code>对应的方法，并通过<code>getMethodNoSuper_nolock</code>方法获取方法的<code>method_t</code>结构。</p>
<p>那么<code>getMethodNoSuper_nolock</code>是如何在<code>methodlist</code>中查找对应的方法的呢？</p>
<h5 id="getMethodNoSuper-nolock"><a href="#getMethodNoSuper-nolock" class="headerlink" title="getMethodNoSuper_nolock"></a>getMethodNoSuper_nolock</h5><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs objc">/ 在类的方法列表中查找对应的方法实现<br><span class="hljs-keyword">static</span> method_t *<br>getMethodNoSuper_nolock(Class cls, SEL sel)<br>&#123;<br>    runtimeLock.assertLocked();<br><br>    assert(cls-&gt;isRealized());<br><br>    <span class="hljs-comment">// 方法列表的遍历</span><br>    <span class="hljs-keyword">for</span> (auto mlists = cls-&gt;data()-&gt;methods.beginLists(),<br>              end = cls-&gt;data()-&gt;methods.endLists(); <br>         mlists != end;<br>         ++mlists)<br>    &#123;<br>        <span class="hljs-comment">// 在mlists中查找sel</span><br>        method_t *m = search_method_list(*mlists, sel);<br>        <span class="hljs-keyword">if</span> (m) <span class="hljs-keyword">return</span> m;<br>    &#125;<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>我们先忽略for循环里的逻辑，我们先看下<code>search_method_list</code>这个方法：</p>
<h5 id="search-method-list"><a href="#search-method-list" class="headerlink" title="search_method_list"></a>search_method_list</h5><p>这个方法的实现 主要实现是<code>findMethodInSortedMethodList</code>方法实现，我们直接看下这个方法</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><code class="hljs objc"><span class="hljs-comment">// 在list中查找方法为key的</span><br><span class="hljs-keyword">static</span> method_t *findMethodInSortedMethodList(SEL key, <span class="hljs-keyword">const</span> method_list_t *list)<br>&#123;<br>    assert(list);<br><br>    <span class="hljs-keyword">const</span> method_t * <span class="hljs-keyword">const</span> first = &amp;list-&gt;first;<br>    <span class="hljs-keyword">const</span> method_t *base = first;<br>    <span class="hljs-comment">// 标志位</span><br>    <span class="hljs-keyword">const</span> method_t *probe;<br>    <span class="hljs-comment">// 要查找的方法的名称</span><br>    uintptr_t keyValue = (uintptr_t)key;<br>    <span class="hljs-comment">// 方法列表中方法的个数</span><br>    uint32_t count;<br>    <span class="hljs-comment">// 遍历方法列表 每次遍历count &gt;&gt;= 1 count每次遍历/2</span><br>    <span class="hljs-keyword">for</span> (count = list-&gt;count; count != <span class="hljs-number">0</span>; count &gt;&gt;= <span class="hljs-number">1</span>) &#123;<br>        <span class="hljs-comment">// base为列表中第一个 count&gt;&gt;1 = count /2 即表示列表中间的位置index</span><br>        probe = base + (count &gt;&gt; <span class="hljs-number">1</span>);<br>        <span class="hljs-comment">// 中间位置的方法的方法名</span><br>        uintptr_t probeValue = (uintptr_t)probe-&gt;name;<br>        <span class="hljs-comment">// 方法名对比 如果刚好中间位置的方法的方法名等于要查找的方法名</span><br>        <span class="hljs-keyword">if</span> (keyValue == probeValue) &#123;<br>            <span class="hljs-comment">// `probe` is a match.</span><br>            <span class="hljs-comment">// Rewind looking for the *first* occurrence of this value.</span><br>            <span class="hljs-comment">// This is required for correct category overrides.</span><br>            <span class="hljs-comment">// 即使查找到了对应的方法 也要向前查找 找到在方法列表中靠前的方法实现</span><br>            <span class="hljs-comment">// 方法列表中是可能存在同名方法的 比如分类重写了方法实现 那么肯定会找到分类的实现返回</span><br>            <span class="hljs-keyword">while</span> (probe &gt; first &amp;&amp; keyValue == (uintptr_t)probe[<span class="hljs-number">-1</span>].name) &#123;<br>                probe--;<br>            &#125;<br>            <span class="hljs-comment">// 返回方法列表中对应方法实现</span><br>            <span class="hljs-keyword">return</span> (method_t *)probe;<br>        &#125;<br>        <span class="hljs-comment">// 如果要查找的方法大于中间位置的方法</span><br>        <span class="hljs-keyword">if</span> (keyValue &gt; probeValue) &#123;<br>            <span class="hljs-comment">// 从中间位置作为base 查找 base-count之间的方法 此处为二分查找 这也侧面验证了method_list_t是一个有序列表</span><br>            base = probe + <span class="hljs-number">1</span>;<br>            count--;<br>        &#125;<br>    &#125;<br>    <br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>通过方法的注释我们可以清晰的看到这个方法的功能是：在方法列表中查找传入的方法，查找方法为二分查找，比较方法是否相等的条件为判断方法名是否相同。当然这里还存在一个如果方法列表中包含多个同名函数我们会向前查找，找到方法列表中第一个与要查找方法同名的方法。</p>
<h4 id="class-addMethod"><a href="#class-addMethod" class="headerlink" title="class_addMethod"></a>class_addMethod</h4><p>顾名思义，这个方法的作用是在类中添加一个方法，我们先来看下方法实现：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs objc">class_addMethod(Class cls, SEL name, IMP imp, <span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span> *types)<br>&#123;<br>    <span class="hljs-keyword">if</span> (!cls) <span class="hljs-keyword">return</span> <span class="hljs-literal">NO</span>;<br><br>    mutex_locker_t lock(runtimeLock);<br>    <span class="hljs-keyword">return</span> ! addMethod(cls, name, imp, types ?: <span class="hljs-string">&quot;&quot;</span>, <span class="hljs-literal">NO</span>);<br>&#125;<br></code></pre></td></tr></table></figure>

<p><code>class_addMethod</code>中主要是调用了<code>addMethod</code>静态方法，该方法的返回值是要添加的方法的实现。</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><code class="hljs objc"><span class="hljs-comment">// 像cls类中添加名为name实现为imp编码为types的方法</span><br><span class="hljs-comment">// replace 表示是否需要替换方法实现</span><br><span class="hljs-keyword">static</span> IMP <br>addMethod(Class cls, SEL name, IMP imp, <span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span> *types, <span class="hljs-keyword">bool</span> replace)<br>&#123;<br>    IMP result = <span class="hljs-literal">nil</span>;<br><br>    runtimeLock.assertLocked();<br><br>    checkIsKnownClass(cls);<br>    <br>    assert(types);<br>    assert(cls-&gt;isRealized());<span class="hljs-comment">//</span><br><br>    method_t *m;<br>    <span class="hljs-comment">// 先从cls中获取名为name的方法实现 如果可以找到方法</span><br>    <span class="hljs-keyword">if</span> ((m = getMethodNoSuper_nolock(cls, name))) &#123;<br>        <span class="hljs-comment">// already exists</span><br>        <span class="hljs-comment">// 类中已有该方法 判断是否需要替换方法实现</span><br>        <span class="hljs-keyword">if</span> (!replace) &#123;<br>            <span class="hljs-comment">// 不需要替换直接返回该方法的实现</span><br>            result = m-&gt;imp;<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-comment">// 需要替换则调用_method_setImplementation方法替换方法实现</span><br>            result = _method_setImplementation(cls, m, imp);<br>        &#125;<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-comment">// fixme optimize</span><br>        <span class="hljs-comment">// 如果当前类的方法列表中不包含名为name的方法</span><br>        <span class="hljs-comment">// 新创建一个method_list_t结构体 并赋值</span><br>        method_list_t *newlist;<br>        newlist = (method_list_t *)calloc(<span class="hljs-keyword">sizeof</span>(*newlist), <span class="hljs-number">1</span>);<br>        newlist-&gt;entsizeAndFlags = <br>            (uint32_t)<span class="hljs-keyword">sizeof</span>(method_t) | fixed_up_method_list;<br>        newlist-&gt;count = <span class="hljs-number">1</span>;<br>        newlist-&gt;first.name = name;<br>        newlist-&gt;first.types = strdupIfMutable(types);<br>        newlist-&gt;first.imp = imp;<br>        <span class="hljs-comment">// 将新建的newlist添加到已有的方法列表中</span><br>        prepareMethodLists(cls, &amp;newlist, <span class="hljs-number">1</span>, <span class="hljs-literal">NO</span>, <span class="hljs-literal">NO</span>);<br>        cls-&gt;data()-&gt;methods.attachLists(&amp;newlist, <span class="hljs-number">1</span>);<br>        <span class="hljs-comment">// 刷新缓存</span><br>        flushCaches(cls);<br><br>        result = <span class="hljs-literal">nil</span>;<br>    &#125;<br><br>    <span class="hljs-keyword">return</span> result;<br>&#125;<br></code></pre></td></tr></table></figure>

<p><code>addMethod</code>方法主要的实现为：</p>
<p>先从cls中获取名为name的方法实现 如果可以找到方法，判断是否需要替换方法实现 如果需要则替换 如果不需要直接返回，如果找不到新创建一个<code>method_list_t</code>结构体 并赋值，将新建的<code>newlist</code>添加到已有的方法列表中，刷新缓存 并返回nil。</p>
<p>因此这个方法的返回值表示：</p>
<p>如果返回值不为空则表示这个方法本来就存在于方法列表中，如果返回值为nil则表示这个方法不存在与方法列表中。而<code>class_addMethod</code>则是对<code>addMethod</code>方法的返回值进行取反，因此<code>class_addMethod</code>的返回值如果为true则表示方法不存在与方法列表中(然后添加到了方法列表中)，返回值为false则表示方法之前就在方法列表中，不需要添加。</p>
<p>看完这部分问题二和问题三的答案也比较明显了：实际上<code>class_addMethod</code>的调用实际上是为了确认</p>
<ul>
<li>要替换的方法是否已经在方法列表中(方法是否已经实现)</li>
<li>如果不在方法列表中，那么需要先将方法添加到方法列表中</li>
</ul>
<p>如果方法没有在方法列表中，那么我们要完成方法交换需要调用<code>class_replaceMethod</code>方法，如果方法列表中已经有了该方法那么我们直接调用<code>method_exchangeImplementations</code>来实现方法的交换。</p>
<h4 id="class-replaceMethod"><a href="#class-replaceMethod" class="headerlink" title="class_replaceMethod"></a>class_replaceMethod</h4><p>我们先来看下这个方法的实现：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs objc">IMP <br>class_replaceMethod(Class cls, SEL name, IMP imp, <span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span> *types)<br>&#123;<br>    <span class="hljs-keyword">if</span> (!cls) <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>;<br><br>    mutex_locker_t lock(runtimeLock);<br>    <span class="hljs-comment">// 这个方法的实现实际上也是调用了addMethod方法 注意这里replace参数为yes</span><br>    <span class="hljs-keyword">return</span> addMethod(cls, name, imp, types ?: <span class="hljs-string">&quot;&quot;</span>, <span class="hljs-literal">YES</span>);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>第一眼看到这个方法的实现时，我也是一脸懵逼，说好的替换方法呢 为何只是调用了<code>addMethod</code>？</p>
<p>首先 我们要务必再次明确调用这个方法的前提是：这个类中并没有要交换的方法。虽然我们在前一步中添加了实现，但是如果我们要实现方法交换肯定是要存在两个方法的，因此带着这个疑问我们再次看下方法交换的代码实现：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs objc"><span class="hljs-built_in">BOOL</span> didAddMethod = class_addMethod(<span class="hljs-keyword">class</span>,origSel,<br>                                        method_getImplementation(altMethod),<br>                                        method_getTypeEncoding(altMethod));<br>    <br>    <span class="hljs-keyword">if</span> (didAddMethod) &#123;<br>        class_replaceMethod(<span class="hljs-keyword">class</span>,altSel,<br>                            method_getImplementation(origMethod),<br>                            method_getTypeEncoding(origMethod));<br>    &#125;<br></code></pre></td></tr></table></figure>

<p>在调用class_addMethod我们传递的参数是：</p>
<table>
<thead>
<tr>
<th>方法</th>
<th>方法名</th>
<th>参数</th>
</tr>
</thead>
<tbody><tr>
<td>class_addMethod</td>
<td>origSel 原始方法名</td>
<td>新自定义方法的方法实现和方法参数编码</td>
</tr>
<tr>
<td>class_replaceMethod</td>
<td>altSel 新定义的方法名</td>
<td>原始方法的方法实现和方法编码</td>
</tr>
</tbody></table>
<h4 id="method-exchangeImplementations"><a href="#method-exchangeImplementations" class="headerlink" title="method_exchangeImplementations"></a>method_exchangeImplementations</h4><p>下面我们在来看下这个方法的实现：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs objc"><span class="hljs-comment">// 方法交换实现 m1 和 m2 分别表示要交换的两个方法</span><br><span class="hljs-keyword">void</span> method_exchangeImplementations(Method m1, Method m2)<br>&#123;<br>    <span class="hljs-keyword">if</span> (!m1  ||  !m2) <span class="hljs-keyword">return</span>;<br><br>    mutex_locker_t lock(runtimeLock);<br><br>    <span class="hljs-comment">// 方法交换仅仅是交换了两个方法的imp指针</span><br>    IMP m1_imp = m1-&gt;imp;<br>    m1-&gt;imp = m2-&gt;imp;<br>    m2-&gt;imp = m1_imp;<br><br><br>    <span class="hljs-comment">// RR/AWZ updates are slow because class is unknown</span><br>    <span class="hljs-comment">// Cache updates are slow because class is unknown</span><br>    <span class="hljs-comment">// fixme build list of classes whose Methods are known externally?</span><br>    <span class="hljs-comment">// 更新缓存</span><br>    flushCaches(<span class="hljs-literal">nil</span>);<br>    <span class="hljs-comment">// 更新两个方法的自定义 方法  rr 表示retain/release等方法 awz 表示allocwithzone方法</span><br>    updateCustomRR_AWZ(<span class="hljs-literal">nil</span>, m1);<br>    updateCustomRR_AWZ(<span class="hljs-literal">nil</span>, m2);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>交换方法的实现就更简单了：直接交换<code>Method</code>结构体中的<code>imp</code>指针，<code>imp</code>指针又是指向了方法的实现。因此这里就完成了两个方法的交换。</p>
<p>上面我们就看完了方法交换的整个流程，我们仍有几个问题没想通</p>
<h6 id="问题一："><a href="#问题一：" class="headerlink" title="问题一："></a>问题一：</h6><p>大多数方法都是交换一个类中的两个方法，是否可以交换两个不同类的方法呢？方法名相同可以交换吗？</p>
<p>我封装了下面这个方法 用来交换两个类的两个方法</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs objc"><br><br>+ (<span class="hljs-built_in">BOOL</span>)swizzleMethod:(Class)originClass swizzCls:(Class)swizzClass orgSel:(SEL)origSel swizzSel:(SEL)swizzSel &#123;<br>    Method origMethod = class_getInstanceMethod(originClass, origSel);<br>    Method altMethod = class_getInstanceMethod(swizzClass, swizzSel);<br>    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;swizzleMethod origMethod %@&quot;</span>,<span class="hljs-built_in">NSStringFromSelector</span>(method_getName(origMethod)));<br>    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;swizzleMethod altMethod %@&quot;</span>,<span class="hljs-built_in">NSStringFromSelector</span>(method_getName(altMethod)));<br><br>    <span class="hljs-built_in">BOOL</span> didAddMethod = class_addMethod(originClass,origSel,<br>                                        method_getImplementation(altMethod),<br>                                        method_getTypeEncoding(altMethod));<br><br>    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;swizzleMethod didAddMethod %@&quot;</span>,@(didAddMethod));<br>    <span class="hljs-keyword">if</span> (didAddMethod) &#123;<br>        class_replaceMethod(swizzClass,swizzSel,<br>                            method_getImplementation(origMethod),<br>                            method_getTypeEncoding(origMethod));<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        method_exchangeImplementations(origMethod, altMethod);<br>    &#125;<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">YES</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>方法交换：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs objc">[<span class="hljs-keyword">self</span> swizzleMethod:[Person <span class="hljs-keyword">class</span>] swizzCls:[Tiger <span class="hljs-keyword">class</span>] orgSel:<span class="hljs-keyword">@selector</span>(speak) swizzSel:<span class="hljs-keyword">@selector</span>(yall)];<br></code></pre></td></tr></table></figure>
<p>这里我们交换了<code>Person</code>类的<code>speak</code>方法和<code>Tiger</code>类的<code>yall</code>方法，然后分别调用这两个方法</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs objc">Tiger.m<br>- (<span class="hljs-keyword">void</span>)yall &#123;<br>    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;Tiger -- yall&quot;</span>);<br>&#125;<br>-------<br>Person.m<br>- (<span class="hljs-keyword">void</span>)speak &#123;<br>    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;Person speak&quot;</span>);<br>&#125;<br><br>ViewController.m<br>- (<span class="hljs-keyword">void</span>)testExchangeTwoClsTwoMethod &#123;<br>    Person *p = [[Person alloc] init];<br>    [p speak];<br>    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;-----&quot;</span>);<br>    Tiger *t = [[Tiger alloc] init];<br>    [t yall];<br>&#125;<br></code></pre></td></tr></table></figure>
<p>打印结果为：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs objc"><span class="hljs-number">2020</span><span class="hljs-number">-10</span><span class="hljs-number">-25</span> <span class="hljs-number">20</span>:<span class="hljs-number">05</span>:<span class="hljs-number">24.400998</span>+<span class="hljs-number">0800</span> MethodSwizzlzeDemo[<span class="hljs-number">27125</span>:<span class="hljs-number">11429192</span>] swizzleMethod didAddMethod <span class="hljs-number">0</span><br><span class="hljs-number">2020</span><span class="hljs-number">-10</span><span class="hljs-number">-25</span> <span class="hljs-number">20</span>:<span class="hljs-number">05</span>:<span class="hljs-number">24.455871</span>+<span class="hljs-number">0800</span> MethodSwizzlzeDemo[<span class="hljs-number">27125</span>:<span class="hljs-number">11429192</span>] Tiger -- yall<br><span class="hljs-number">2020</span><span class="hljs-number">-10</span><span class="hljs-number">-25</span> <span class="hljs-number">20</span>:<span class="hljs-number">05</span>:<span class="hljs-number">24.456007</span>+<span class="hljs-number">0800</span> MethodSwizzlzeDemo[<span class="hljs-number">27125</span>:<span class="hljs-number">11429192</span>] -----<br><span class="hljs-number">2020</span><span class="hljs-number">-10</span><span class="hljs-number">-25</span> <span class="hljs-number">20</span>:<span class="hljs-number">05</span>:<span class="hljs-number">24.456143</span>+<span class="hljs-number">0800</span> MethodSwizzlzeDemo[<span class="hljs-number">27125</span>:<span class="hljs-number">11429192</span>] Person speak<br></code></pre></td></tr></table></figure>
<p>从调用结果可以看出我们的方法交换是成功的。因此 这可以证明我们是可以交换两个类的两个方法的。</p>
<h6 id="问题二："><a href="#问题二：" class="headerlink" title="问题二："></a>问题二：</h6><p>我们是否可以交换一个不存在的方法？会有什么效果？</p>
<p>方法交换调用：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs objc">[<span class="hljs-keyword">self</span> swizzleMethod:[Person <span class="hljs-keyword">class</span>] swizzCls:[Tiger <span class="hljs-keyword">class</span>] orgSel:<span class="hljs-keyword">@selector</span>(speak) swizzSel:<span class="hljs-keyword">@selector</span>(speak)];<br></code></pre></td></tr></table></figure>
<p>我们的Tiger类并没有speak方法,我们看下控制台输出</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs objc"><span class="hljs-number">2020</span><span class="hljs-number">-10</span><span class="hljs-number">-25</span> <span class="hljs-number">20</span>:<span class="hljs-number">08</span>:<span class="hljs-number">34.567600</span>+<span class="hljs-number">0800</span> MethodSwizzlzeDemo[<span class="hljs-number">27181</span>:<span class="hljs-number">11431963</span>] swizzleMethod origMethod speak<br><span class="hljs-number">2020</span><span class="hljs-number">-10</span><span class="hljs-number">-25</span> <span class="hljs-number">20</span>:<span class="hljs-number">08</span>:<span class="hljs-number">34.568215</span>+<span class="hljs-number">0800</span> MethodSwizzlzeDemo[<span class="hljs-number">27181</span>:<span class="hljs-number">11431963</span>] swizzleMethod altMethod (null)<br><span class="hljs-number">2020</span><span class="hljs-number">-10</span><span class="hljs-number">-25</span> <span class="hljs-number">20</span>:<span class="hljs-number">08</span>:<span class="hljs-number">34.568399</span>+<span class="hljs-number">0800</span> MethodSwizzlzeDemo[<span class="hljs-number">27181</span>:<span class="hljs-number">11431963</span>] swizzleMethod didAddMethod <span class="hljs-number">0</span><br><span class="hljs-number">2020</span><span class="hljs-number">-10</span><span class="hljs-number">-25</span> <span class="hljs-number">20</span>:<span class="hljs-number">08</span>:<span class="hljs-number">34.614912</span>+<span class="hljs-number">0800</span> MethodSwizzlzeDemo[<span class="hljs-number">27181</span>:<span class="hljs-number">11431963</span>] Person speak<br><span class="hljs-number">2020</span><span class="hljs-number">-10</span><span class="hljs-number">-25</span> <span class="hljs-number">20</span>:<span class="hljs-number">08</span>:<span class="hljs-number">34.615029</span>+<span class="hljs-number">0800</span> MethodSwizzlzeDemo[<span class="hljs-number">27181</span>:<span class="hljs-number">11431963</span>] -----<br><span class="hljs-number">2020</span><span class="hljs-number">-10</span><span class="hljs-number">-25</span> <span class="hljs-number">20</span>:<span class="hljs-number">08</span>:<span class="hljs-number">34.615114</span>+<span class="hljs-number">0800</span> MethodSwizzlzeDemo[<span class="hljs-number">27181</span>:<span class="hljs-number">11431963</span>] Tiger -- yall<br></code></pre></td></tr></table></figure>
<p>由上面控制台输出结果我们看出，方法交换实际并未成功，且在方法交换是打印<code>altMethod</code>结果为null。因此如果去交换一个并不存在的方法是不可能实现的。</p>
<p>但是如果我们换成另外一种写法：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs objc">[<span class="hljs-keyword">self</span> swizzleMethod:[Tiger <span class="hljs-keyword">class</span>] swizzCls:[Person <span class="hljs-keyword">class</span>] orgSel:<span class="hljs-keyword">@selector</span>(speak) swizzSel:<span class="hljs-keyword">@selector</span>(speak)];<br><br></code></pre></td></tr></table></figure>
<p>我们再看下输出结果：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs objc"><span class="hljs-number">2020</span><span class="hljs-number">-10</span><span class="hljs-number">-26</span> <span class="hljs-number">22</span>:<span class="hljs-number">29</span>:<span class="hljs-number">43.179796</span>+<span class="hljs-number">0800</span> MethodSwizzlzeDemo[<span class="hljs-number">1853</span>:<span class="hljs-number">33972</span>] swizzleMethod origMethod (null)<br><span class="hljs-number">2020</span><span class="hljs-number">-10</span><span class="hljs-number">-26</span> <span class="hljs-number">22</span>:<span class="hljs-number">29</span>:<span class="hljs-number">43.180534</span>+<span class="hljs-number">0800</span> MethodSwizzlzeDemo[<span class="hljs-number">1853</span>:<span class="hljs-number">33972</span>] swizzleMethod altMethod speak<br><span class="hljs-number">2020</span><span class="hljs-number">-10</span><span class="hljs-number">-26</span> <span class="hljs-number">22</span>:<span class="hljs-number">29</span>:<span class="hljs-number">43.180695</span>+<span class="hljs-number">0800</span> MethodSwizzlzeDemo[<span class="hljs-number">1853</span>:<span class="hljs-number">33972</span>] swizzleMethod didAddMethod <span class="hljs-number">1</span><br></code></pre></td></tr></table></figure>
<p>从日志我们看到，方法添加成功！也就是说 我们可以交换一个不存在的方法，因为在方法交换时我们在利用运行时方法在类里添加了对应方法。那么我们看下是否可以成功调用呢？</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs objc">- (<span class="hljs-keyword">void</span>)testExchangeTwoClsTwoMethod &#123;<br>    Person *p = [[Person alloc] init];<br>    [p speak];<br>    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;-----&quot;</span>);<br>    Tiger *t = [[Tiger alloc] init];<br>    [t performSelector:<span class="hljs-keyword">@selector</span>(speak)];<br>&#125;<br></code></pre></td></tr></table></figure>

<p>打印结果：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs objc"><span class="hljs-number">2020</span><span class="hljs-number">-10</span><span class="hljs-number">-26</span> <span class="hljs-number">22</span>:<span class="hljs-number">35</span>:<span class="hljs-number">40.918735</span>+<span class="hljs-number">0800</span> MethodSwizzlzeDemo[<span class="hljs-number">1957</span>:<span class="hljs-number">39109</span>] swizzleMethod origMethod (null)<br><span class="hljs-number">2020</span><span class="hljs-number">-10</span><span class="hljs-number">-26</span> <span class="hljs-number">22</span>:<span class="hljs-number">35</span>:<span class="hljs-number">40.919307</span>+<span class="hljs-number">0800</span> MethodSwizzlzeDemo[<span class="hljs-number">1957</span>:<span class="hljs-number">39109</span>] swizzleMethod altMethod speak<br><span class="hljs-number">2020</span><span class="hljs-number">-10</span><span class="hljs-number">-26</span> <span class="hljs-number">22</span>:<span class="hljs-number">35</span>:<span class="hljs-number">40.919464</span>+<span class="hljs-number">0800</span> MethodSwizzlzeDemo[<span class="hljs-number">1957</span>:<span class="hljs-number">39109</span>] swizzleMethod didAddMethod <span class="hljs-number">1</span><br><span class="hljs-number">2020</span><span class="hljs-number">-10</span><span class="hljs-number">-26</span> <span class="hljs-number">22</span>:<span class="hljs-number">36</span>:<span class="hljs-number">15.806909</span>+<span class="hljs-number">0800</span> MethodSwizzlzeDemo[<span class="hljs-number">1957</span>:<span class="hljs-number">39109</span>] Person speak<br><span class="hljs-number">2020</span><span class="hljs-number">-10</span><span class="hljs-number">-26</span> <span class="hljs-number">22</span>:<span class="hljs-number">36</span>:<span class="hljs-number">15.807017</span>+<span class="hljs-number">0800</span> MethodSwizzlzeDemo[<span class="hljs-number">1957</span>:<span class="hljs-number">39109</span>] -----<br><span class="hljs-number">2020</span><span class="hljs-number">-10</span><span class="hljs-number">-26</span> <span class="hljs-number">22</span>:<span class="hljs-number">36</span>:<span class="hljs-number">15.807117</span>+<span class="hljs-number">0800</span> MethodSwizzlzeDemo[<span class="hljs-number">1957</span>:<span class="hljs-number">39109</span>] Person speak<br></code></pre></td></tr></table></figure>
<p>从结果我们看出，调用<code>tiger</code>的<code>speak</code>方法时打印出了<code>Person speak</code>,这说明为Tiger动态增加了一个方法方法实现和<code>Person</code>相同，然后在去替换<code>Person</code>类的<code>speak</code>时因为<code>originMethod</code>为<code>null</code>因此替换不成功，因此这个方法相当于给<code>Tiger</code>增加了一个<code>speak</code>方法。</p>
<h6 id="问题三："><a href="#问题三：" class="headerlink" title="问题三："></a>问题三：</h6><p>仔细看下下面这段代码：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs objc">[<span class="hljs-keyword">self</span> swizzleMethod:[Tiger <span class="hljs-keyword">class</span>] swizzCls:[Person <span class="hljs-keyword">class</span>] orgSel:<span class="hljs-keyword">@selector</span>(walk) swizzSel:<span class="hljs-keyword">@selector</span>(speak)];<br><br></code></pre></td></tr></table></figure>
<p><code>Tiger</code>继承自<code>Animal</code>,<code>walk</code>是<code>Animal</code>对象中的一个实例方法：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs objc"><span class="hljs-class"><span class="hljs-keyword">@interface</span> <span class="hljs-title">Animal</span> : <span class="hljs-title">NSObject</span></span><br><br>- (<span class="hljs-keyword">void</span>)walk;<br><br>- (<span class="hljs-keyword">void</span>)eat;<br><br><span class="hljs-keyword">@end</span><br><br><span class="hljs-class"><span class="hljs-keyword">@interface</span> <span class="hljs-title">Tiger</span> : <span class="hljs-title">Animal</span></span><br><br>- (<span class="hljs-keyword">void</span>)yall;<br><br><span class="hljs-keyword">@end</span><br><br></code></pre></td></tr></table></figure>

<p>但是当我断点调试时，却发现</p>
<p><img src="https://tva1.sinaimg.cn/large/0081Kckwly1gk34f6r9ykj31p50u0qqm.jpg"></p>
<p>从图中我们看到：<code>altMethod</code>和<code>origMethod</code>这两个方法是可以获取到的，但是<code>didAddMethod</code>的值返回了YES。这说明我们在<code>Tiger</code>的方法列表中并没有找到<code>walk</code>方法。但是使用<code>class_getInstanceMethod</code>方法获取到的方法是有值的，这是怎么回事呢？</p>
<p>当我们仔细查看<code>class_addMethod</code>方法实现时我们发现了一处代码：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs objc"><span class="hljs-keyword">if</span> ((m = getMethodNoSuper_nolock(cls, name))) &#123;<br>    <span class="hljs-comment">// 找到该类中对应的方法</span><br>&#125; <span class="hljs-keyword">else</span> &#123;<br>   <span class="hljs-comment">// 没有找到对应的方法</span><br>&#125;<br></code></pre></td></tr></table></figure>

<p>我们在对比<code>class_getInstanceMethod</code>方法获取方法的位置实现：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs objc"><span class="hljs-comment">// 这里通过while循环的方式不断的查找当前类-&gt;父类-&gt;...的方法查找这个方法 直到找到方法或者是找到cls-&gt;superclass=nil</span><br><span class="hljs-keyword">while</span> (cls  &amp;&amp;  ((m = getMethodNoSuper_nolock(cls, sel))) == <span class="hljs-literal">nil</span>) &#123;<br>    cls = cls-&gt;superclass;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>经过代码的对比我们很容易发现，在<code>class_addMethod</code>方法中我们只是查找了当前类的方法列表，而在<code>class_getInstanceMethod</code>方法中我们会递归查询当前类以及其父类的方法列表。</p>
<p>因此在Tiger类中找不到walk方法是正常的。</p>
<h4 id="类方法的方法交换"><a href="#类方法的方法交换" class="headerlink" title="类方法的方法交换"></a>类方法的方法交换</h4><p>跟交换对象方法相同，我们先来看下这个方法：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs objc">+ (<span class="hljs-built_in">BOOL</span>)swizzleMethod:(Class)<span class="hljs-keyword">class</span> orgSel:(SEL)origSel swizzSel:(SEL)altSel &#123;<br>    <span class="hljs-comment">// 获取方法改为class_getClassMethod方法</span><br>    Method origMethod = class_getClassMethod(<span class="hljs-keyword">class</span>, origSel);<br>    Method altMethod = class_getClassMethod(<span class="hljs-keyword">class</span>, altSel);<br>    <br>    <br>    <span class="hljs-built_in">BOOL</span> didAddMethod = class_addMethod(<span class="hljs-keyword">class</span>,origSel,<br>                                        method_getImplementation(altMethod),<br>                                        method_getTypeEncoding(altMethod));<br>    <br>    <span class="hljs-keyword">if</span> (didAddMethod) &#123;<br>      <span class="hljs-comment">// 方法已经添加</span><br>        class_replaceMethod(<span class="hljs-keyword">class</span>,altSel,<br>                            method_getImplementation(origMethod),<br>                            method_getTypeEncoding(origMethod));<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        method_exchangeImplementations(origMethod, altMethod);<br>    &#125;<br>    <br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">YES</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>从上面的代码我们看到，交换类方法和交换对象方法相比我们只是修改了获取方法结构的方法为<code>class_getClassMethod</code>。</p>
<p>下面我们看下这个方法的实现：</p>
<h5 id="class-getClassMethod"><a href="#class-getClassMethod" class="headerlink" title="class_getClassMethod"></a>class_getClassMethod</h5><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs objc"><span class="hljs-comment">// 获取指定类的类方法</span><br>Method class_getClassMethod(Class cls, SEL sel)<br>&#123;<br>    <span class="hljs-keyword">if</span> (!cls  ||  !sel) <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>;<br><br>    <span class="hljs-comment">// 获取类的元类的方法</span><br>    <span class="hljs-keyword">return</span> class_getInstanceMethod(cls-&gt;getMeta(), sel);<br>&#125;<br></code></pre></td></tr></table></figure>
<p>其实内部实现很简单，获取类的元类对应的实例方法。</p>
<p>下面我们看下方法调用和最终结果：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs objc">+ (<span class="hljs-keyword">void</span>)load &#123;<br>    <span class="hljs-keyword">static</span> <span class="hljs-built_in">dispatch_once_t</span> onceToken;<br>    <span class="hljs-built_in">dispatch_once</span>(&amp;onceToken, ^&#123;<br>        [<span class="hljs-keyword">self</span> swizzleClassMethod:[<span class="hljs-keyword">self</span> <span class="hljs-keyword">class</span>] orgSel:<span class="hljs-keyword">@selector</span>(classMethod1) swizzSel:<span class="hljs-keyword">@selector</span>(classMethod2)];<br>    &#125;);<br>&#125;<br><br>+ (<span class="hljs-keyword">void</span>)classMethod1 &#123;<br>    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;classMethod1&quot;</span>);<br>&#125;<br><br>+ (<span class="hljs-keyword">void</span>)classMethod2 &#123;<br>    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;classMethod2&quot;</span>);<br>&#125;<br><br>- (<span class="hljs-keyword">void</span>)viewDidLoad &#123;<br>    [<span class="hljs-keyword">super</span> viewDidLoad];<br>    [ViewController classMethod1];<br>    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;-------------------------&quot;</span>);<br>    [ViewController classMethod2];<br>&#125;<br></code></pre></td></tr></table></figure>
<p>我们来看下打印结果：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs objc"><span class="hljs-number">2020</span><span class="hljs-number">-10</span><span class="hljs-number">-27</span> <span class="hljs-number">22</span>:<span class="hljs-number">42</span>:<span class="hljs-number">20.314694</span>+<span class="hljs-number">0800</span> MethodSwizzlzeDemo[<span class="hljs-number">4950</span>:<span class="hljs-number">153595</span>] swizzleClassMethod didAddMethod <span class="hljs-number">1</span><br><span class="hljs-number">2020</span><span class="hljs-number">-10</span><span class="hljs-number">-27</span> <span class="hljs-number">22</span>:<span class="hljs-number">42</span>:<span class="hljs-number">20.360568</span>+<span class="hljs-number">0800</span> MethodSwizzlzeDemo[<span class="hljs-number">4950</span>:<span class="hljs-number">153595</span>] classMethod1<br><span class="hljs-number">2020</span><span class="hljs-number">-10</span><span class="hljs-number">-27</span> <span class="hljs-number">22</span>:<span class="hljs-number">42</span>:<span class="hljs-number">20.360679</span>+<span class="hljs-number">0800</span> MethodSwizzlzeDemo[<span class="hljs-number">4950</span>:<span class="hljs-number">153595</span>] -------------------------<br><span class="hljs-number">2020</span><span class="hljs-number">-10</span><span class="hljs-number">-27</span> <span class="hljs-number">22</span>:<span class="hljs-number">42</span>:<span class="hljs-number">20.360790</span>+<span class="hljs-number">0800</span> MethodSwizzlzeDemo[<span class="hljs-number">4950</span>:<span class="hljs-number">153595</span>] classMethod2<br></code></pre></td></tr></table></figure>
<p>从结果我们看到，我们的交换方法并不成功。而且我们发现<code>didAddMethod</code>标记为1，也就是说在<code>class</code>中并未找到类方法<code>origSel</code>。很明显问题出在了<code>class_addMethod</code>方法里。上面我们已经分析了这个方法，他的实现实际上是从类中非递归的在方法列表中查找方法。</p>
<p>但是我们都知道类方法实际上是存放在元类中的，这一点在<code>class_getClassMethod</code>的实现中我们也能得到验证</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs objc">class_getInstanceMethod(cls-&gt;getMeta(), sel);<br></code></pre></td></tr></table></figure>
<p>那么我们这里在方法添加时也应该从元类的方法列表中查找对应的类方法，那么如何获取这个类的元类呢，我们知道每个类对象中都有一个isa指针指向了他的元类。因此我们可以通过下面这个方法获取。</p>
<h5 id="object-getClass"><a href="#object-getClass" class="headerlink" title="object_getClass"></a>object_getClass</h5><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs objc">Class object_getClass(<span class="hljs-keyword">id</span> obj)<br>&#123;<br>    <span class="hljs-keyword">if</span> (obj) <span class="hljs-keyword">return</span> obj-&gt;getIsa();<br>    <span class="hljs-keyword">else</span> <span class="hljs-keyword">return</span> Nil;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>利用上面这个方法我们对方法交换函数进行修改</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs objc">+ (<span class="hljs-built_in">BOOL</span>)swizzleMethod:(Class)<span class="hljs-keyword">class</span> orgSel:(SEL)origSel swizzSel:(SEL)altSel &#123;<br>    <span class="hljs-comment">// 获取方法改为class_getClassMethod方法</span><br>    Method origMethod = class_getClassMethod(<span class="hljs-keyword">class</span>, origSel);<br>    Method altMethod = class_getClassMethod(<span class="hljs-keyword">class</span>, altSel);<br>    <br>    <span class="hljs-comment">// 这里改为object_getClass</span><br>    <span class="hljs-built_in">BOOL</span> didAddMethod = class_addMethod(object_getClass(<span class="hljs-keyword">class</span>),origSel,<br>                                        method_getImplementation(altMethod),<br>                                        method_getTypeEncoding(altMethod));<br>    <br>    <span class="hljs-keyword">if</span> (didAddMethod) &#123;<br>      <span class="hljs-comment">// 方法已经添加</span><br>        class_replaceMethod(<span class="hljs-keyword">class</span>,altSel,<br>                            method_getImplementation(origMethod),<br>                            method_getTypeEncoding(origMethod));<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        method_exchangeImplementations(origMethod, altMethod);<br>    &#125;<br>    <br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">YES</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>我们再来看下输出结果：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs objc"><span class="hljs-number">2020</span><span class="hljs-number">-10</span><span class="hljs-number">-27</span> <span class="hljs-number">22</span>:<span class="hljs-number">56</span>:<span class="hljs-number">35.223362</span>+<span class="hljs-number">0800</span> MethodSwizzlzeDemo[<span class="hljs-number">5144</span>:<span class="hljs-number">163474</span>] swizzleClassMethod didAddMethod <span class="hljs-number">0</span><br><span class="hljs-number">2020</span><span class="hljs-number">-10</span><span class="hljs-number">-27</span> <span class="hljs-number">22</span>:<span class="hljs-number">56</span>:<span class="hljs-number">35.267136</span>+<span class="hljs-number">0800</span> MethodSwizzlzeDemo[<span class="hljs-number">5144</span>:<span class="hljs-number">163474</span>] classMethod2<br><span class="hljs-number">2020</span><span class="hljs-number">-10</span><span class="hljs-number">-27</span> <span class="hljs-number">22</span>:<span class="hljs-number">56</span>:<span class="hljs-number">35.267236</span>+<span class="hljs-number">0800</span> MethodSwizzlzeDemo[<span class="hljs-number">5144</span>:<span class="hljs-number">163474</span>] -------------------------<br><span class="hljs-number">2020</span><span class="hljs-number">-10</span><span class="hljs-number">-27</span> <span class="hljs-number">22</span>:<span class="hljs-number">56</span>:<span class="hljs-number">35.267320</span>+<span class="hljs-number">0800</span> MethodSwizzlzeDemo[<span class="hljs-number">5144</span>:<span class="hljs-number">163474</span>] classMethod1<br></code></pre></td></tr></table></figure>

<p>我们发现这里方法交换是成功的了！这样也就完成了类方法的交换</p>
<h3 id="Demo"><a href="#Demo" class="headerlink" title="Demo"></a>Demo</h3><p><a target="_blank" rel="noopener" href="https://github.com/LeeWongSnail/Blog_Demo/tree/master/MethodSwizzlzeDemo">demo代码地址</a></p>

    </div>
     
    <div class="post-footer__meta"><p>更新于 2020-12-05</p></div> 
    <div class="post-meta__cats"><a href="/categories/Runtime/" class="post-cats__link button">Runtime</a><a href="/tags/Runtime-ExchangeImplementations/" class="post-tags__link button"># Runtime ExchangeImplementations</a></div> 
</article>


    <div class="nav">
        <div class="nav__prev">
            
                <a href="/2020/11/15/runtime-msgsend/" class="nav__link">
                    <div>
                        <svg viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" width="24" height="24"><path d="M589.088 790.624L310.464 512l278.624-278.624 45.248 45.248L400.96 512l233.376 233.376z" fill="#808080"></path></svg>
                    </div>
                    <div>
                        <div class="nav__label">
                            Previous Post
                        </div>
                        <div class="nav__title">
                            Runtime之消息转发
                        </div>
                    </div>
                </a>
            
        </div>
        <div class="nav__next">
            
                <a href="/2020/10/24/oc-object-structure/" class="nav__link">
                    <div>
                        <div class="nav__label">
                            Next Post
                        </div>
                        <div class="nav__title">
                            Runtime之NSObject结构
                        </div>
                    </div>
                    <div>
                        <svg viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" width="24" height="24"><path d="M434.944 790.624l-45.248-45.248L623.04 512l-233.376-233.376 45.248-45.248L713.568 512z" fill="#808080"></path></svg>
                    </div>
                </a>
            
        </div>
    </div>





</main>

            <footer class="footer">
    


    
    
    
        <span id="busuanzi_container_site_uv" hidden>
            <span></span>
            <span id="busuanzi_value_site_uv"></span>
            <span>Viewers</span>
            
                <span>|</span>
            
        </span>
    
    
        <span id="busuanzi_container_site_pv" hidden>
            <span></span>
            <span id="busuanzi_value_site_pv"></span>
            <span>Views</span>
            
        </span>
    
 
 

 
    
        
        <p class="footer-copyright">
            Copyright © 2015&nbsp;-&nbsp;2020 <a href="/">LeeWong</a>
        </p>
    
    
    <p>Powered by <a href="https://hexo.io" target="_blank">Hexo</a> | Theme - <a href="https://github.com/ChrAlpha/hexo-theme-cards" target="_blank">Cards</a></p>
</footer>

        </div>
         

 
    <script>
        window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
        ga('create', '4NmLVard-jFEKaV6857m9tKb41Tpo4FiKj8L1TJg7lU', 'auto');
        ga('send', 'pageview');
    </script>
    <script async src="https://www.google-analytics.com/analytics.js"></script>
 

 

 
    <script>
        var _hmt = _hmt || [];
        (function() {
            var hm = document.createElement('script');
            hm.src = 'https://hm.baidu.com/hm.js?DR81zbdrQ3';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(hm, s);
        })();
    </script>
 

  



 


    
 


    
<script src="https://cdn.jsdelivr.net/npm/jquery@3.4.1/dist/jquery.min.js"></script>

    
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.4.1/dist/jquery.fancybox.min.css">

    
<script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.4.1/dist/jquery.fancybox.min.js"></script>

    <script>
        let lazyloadT = Boolean('false'),
            auto_fancybox = Boolean('false')
        if (auto_fancybox) {
            $(".post__content").find('img').each(function () {
                var element = document.createElement("a");
                $(element).attr("data-fancybox", "gallery");
                $(element).attr("href", $(this).attr("src"));
                if (lazyloadT) {
                    $(element).attr("href", $(this).attr("data-srcset"));
                }
                $(this).wrap(element);
            });
        } else {
            $(".post__content").find("fancybox").find('img').each(function () {
                var element = document.createElement("a");
                $(element).attr("data-fancybox", "gallery");
                $(element).attr("href", $(this).attr("src"));
                if (lazyloadT) {
                    $(element).attr("href", $(this).attr("data-srcset"));
                }
                $(this).wrap(element);
            });
        }
    </script>
 

 

 

 




    </body>
</html>
